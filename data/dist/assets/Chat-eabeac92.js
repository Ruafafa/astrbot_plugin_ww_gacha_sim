import{ae as ze,v as b,c as Oe,x as Fe,M as qe,aQ as Qe,o as v,a as z,w as s,b as a,y as Y,n as Q,z as Ue,A as g,t as S,f as e,B as P,l as L,e as h,C as ae,s as X,g as M,p as k,bc as ma,bd as pa,be as fa,bf as ga,Z as ge,J as te,a5 as Ae,H as Le,I as Be,K as ee,R as Ye,S as Ze,T as Ge,u as Xe,F as Ne,h as ha,V as oe,j as ba,Q as Ke,d as le,O as ya,aF as _a,m as Sa,aC as ea,W as wa,U as Ma,E as Ca,aq as ka,aR as Pa}from"./index-61371d60.js";import{useCustomizerStore as Je}from"./customizer-e056107a.js";import{L as Ta,S as xa}from"./LanguageSwitcher-43bc380c.js";import{M as Ia}from"./MessageList-fbdd7c7f.js";import{a as Va,P as $a,A as Ee,b as Da}from"./AstrBotConfig-27eff76a.js";import{_ as We}from"./_plugin-vue_export-helper-c27b6911.js";import{u as Ra,a as Ea,b as Fa,C as Ua}from"./useRecording-073e8009.js";const Aa=x=>(Ye("data-v-55280f9c"),x=x(),Ze(),x),La={class:"d-flex align-center ga-2"},Ba={class:"text-h2 font-weight-bold"},Na={key:0,class:"pa-4"},za={class:"mb-4"},Oa={class:"d-flex align-center justify-space-between mb-3"},Wa={class:"text-h5 font-weight-bold"},Ha={class:"text-caption text-medium-emphasis"},ja={class:"mb-4"},Ka={class:"font-weight-medium"},Ja={key:1,class:"d-flex align-center justify-center",style:{height:"100%"}},qa={class:"text-center text-medium-emphasis"},Qa={class:"mt-4 text-h6"},Ya=Aa(()=>g("small",{style:{color:"gray"}},"不建议修改 ID，可能会导致指向该模型的相关配置（如默认模型、插件相关配置等）失效。",-1)),Za={__name:"ProviderConfigDialog",props:{modelValue:{type:Boolean,default:!1}},emits:["update:modelValue"],setup(x,{emit:A}){const w=x,{tm:t}=ze("features/provider"),l=b(!1);function C(){l.value=window.innerWidth<=768}const $=Oe({get:()=>w.modelValue,set:_=>A("update:modelValue",_)}),I=b({show:!1,message:"",color:"success"});function y(_,p="success"){I.value={show:!0,message:_,color:p}}const{selectedProviderSource:o,availableModels:m,loadingModels:d,savingSource:B,testingProviders:H,isSourceModified:T,configSchema:E,manualModelId:F,modelSearch:c,availableSourceTypes:f,displayedProviderSources:V,filteredMergedModelEntries:N,basicSourceConfig:ie,advancedSourceConfig:ne,manualProviderId:he,resolveSourceIcon:re,getSourceDisplayName:be,supportsImageInput:ye,supportsToolCall:_e,supportsReasoning:Z,formatContextLimit:de,selectProviderSource:Se,addProviderSource:we,deleteProviderSource:Me,saveProviderSource:Ce,fetchAvailableModels:ke,addModelProvider:ue,deleteProvider:Pe,testProvider:Te,loadConfig:se,modelAlreadyConfigured:xe}=Va({defaultTab:"chat_completion",tm:t,showMessage:y}),J=b(!1),q=b(!1),D=b(null),j=b(""),K=b([]);function Ie(){$.value=!1}function Ve(){if(!o.value){y(t("providerSources.selectHint"),"error");return}F.value="",J.value=!0}async function $e(){const _=F.value.trim();if(!o.value){y(t("providerSources.selectHint"),"error");return}if(!_){y(t("models.manualModelRequired"),"error");return}if(xe(_)){y(t("models.manualModelExists"),"error");return}await ue(_),J.value=!1}function De(_){D.value=JSON.parse(JSON.stringify(_)),j.value=_.id,q.value=!0}async function Re(){var _,p;if(D.value){K.value.push(D.value.id);try{const n=await ee.post("/api/config/provider/update",{id:j.value||D.value.id,config:D.value});if(n.data.status==="error")throw new Error(n.data.message);y(n.data.message||t("providerSources.saveSuccess")),q.value=!1,await se()}catch(n){y(((p=(_=n.response)==null?void 0:_.data)==null?void 0:p.message)||n.message||t("providerSources.saveError"),"error")}finally{K.value=K.value.filter(n=>{var U;return n!==((U=D.value)==null?void 0:U.id)})}}}async function ce(_,p){var n,U;_.enable=p;try{const R=await ee.post("/api/config/provider/update",{id:_.id,config:_});if(R.data.status==="error")throw new Error(R.data.message);y(R.data.message||t("messages.success.statusUpdate"))}catch(R){y(((U=(n=R.response)==null?void 0:n.data)==null?void 0:U.message)||R.message||t("providerSources.saveError"),"error")}finally{await se()}}return Fe($,_=>{_&&(se(),C())}),qe(()=>{C(),window.addEventListener("resize",C)}),Qe(()=>{window.removeEventListener("resize",C)}),(_,p)=>(v(),z(te,{modelValue:$.value,"onUpdate:modelValue":p[6]||(p[6]=n=>$.value=n),"max-width":l.value?void 0:"1400",fullscreen:l.value,scrollable:""},{default:s(()=>[a(Y,{class:Q(["provider-config-dialog",{"mobile-dialog":l.value}])},{default:s(()=>[a(Ue,{class:"d-flex align-center justify-space-between pa-4 pb-0"},{default:s(()=>[g("div",La,[g("span",Ba,S(e(t)("title")),1)]),a(P,{icon:"",variant:"text",onClick:Ie},{default:s(()=>[a(L,null,{default:s(()=>[h("mdi-close")]),_:1})]),_:1})]),_:1}),a(ae,{class:Q(["pa-4 pt-0",{"mobile-content":l.value}]),style:X(l.value?{}:{height:"calc(100vh - 200px); max-height: 800px;"})},{default:s(()=>[g("div",{class:Q(l.value?"mobile-layout":"d-flex"),style:X(l.value?{}:{height:"100%"})},[g("div",{class:Q(["provider-sources-column",{"mobile-sources":l.value}]),style:X(l.value?{}:{width:"320px",minWidth:"320px",borderRight:"1px solid rgba(var(--v-border-color), var(--v-border-opacity))",overflowY:"auto"})},[a($a,{"displayed-provider-sources":e(V),"selected-provider-source":e(o),"available-source-types":e(f),tm:e(t),"resolve-source-icon":e(re),"get-source-display-name":e(be),onAddProviderSource:e(we),onSelectProviderSource:e(Se),onDeleteProviderSource:e(Me)},null,8,["displayed-provider-sources","selected-provider-source","available-source-types","tm","resolve-source-icon","get-source-display-name","onAddProviderSource","onSelectProviderSource","onDeleteProviderSource"])],6),g("div",{class:Q(["provider-config-column",{"mobile-config":l.value}]),style:X(l.value?{}:{flex:1,overflowY:"auto",minWidth:0})},[e(o)?(v(),M("div",Na,[g("div",za,[g("div",Oa,[g("div",null,[g("div",Wa,S(e(o).id),1),g("div",Ha,S(e(o).api_base||"N/A"),1)]),a(P,{color:"success","prepend-icon":"mdi-check",loading:e(B),disabled:!e(T),onClick:e(Ce),variant:"flat"},{default:s(()=>[h(S(e(t)("providerSources.save")),1)]),_:1},8,["loading","disabled","onClick"])]),g("div",ja,[e(ie)?(v(),z(Ee,{key:0,iterable:e(ie),metadata:e(E),metadataKey:"provider","is-editing":!0},null,8,["iterable","metadata"])):k("",!0)]),a(ma,{variant:"accordion",class:"mb-4"},{default:s(()=>[a(pa,{elevation:"0",class:"border rounded-lg"},{default:s(()=>[a(fa,null,{default:s(()=>[g("span",Ka,S(e(t)("providerSources.advancedConfig")),1)]),_:1}),a(ga,null,{default:s(()=>[e(ne)?(v(),z(Ee,{key:0,iterable:e(ne),metadata:e(E),metadataKey:"provider","is-editing":!0},null,8,["iterable","metadata"])):k("",!0)]),_:1})]),_:1})]),_:1}),a(Da,{entries:e(N),"available-count":e(m).length,"model-search":e(c),"onUpdate:modelSearch":p[0]||(p[0]=n=>ge(c)?c.value=n:null),"loading-models":e(d),"is-source-modified":e(T),"supports-image-input":e(ye),"supports-tool-call":e(_e),"supports-reasoning":e(Z),"format-context-limit":e(de),"testing-providers":e(H),tm:e(t),onFetchModels:e(ke),onOpenManualModel:Ve,onOpenProviderEdit:De,onToggleProviderEnable:ce,onTestProvider:e(Te),onDeleteProvider:e(Pe),onAddModelProvider:e(ue)},null,8,["entries","available-count","model-search","loading-models","is-source-modified","supports-image-input","supports-tool-call","supports-reasoning","format-context-limit","testing-providers","tm","onFetchModels","onTestProvider","onDeleteProvider","onAddModelProvider"])])])):(v(),M("div",Ja,[g("div",qa,[a(L,{size:"64",color:"grey-lighten-1"},{default:s(()=>[h("mdi-cursor-default-click")]),_:1}),g("p",Qa,S(e(t)("providerSources.selectHint")),1)])]))],6)],6)]),_:1},8,["class","style"])]),_:1},8,["class"]),a(te,{modelValue:J.value,"onUpdate:modelValue":p[3]||(p[3]=n=>J.value=n),"max-width":"400"},{default:s(()=>[a(Y,{title:e(t)("models.manualDialogTitle")},{default:s(()=>[a(ae,{class:"py-4"},{default:s(()=>[a(Ae,{modelValue:e(F),"onUpdate:modelValue":p[1]||(p[1]=n=>ge(F)?F.value=n:null),label:e(t)("models.manualDialogModelLabel"),flat:"",variant:"solo-filled",autofocus:"",clearable:""},null,8,["modelValue","label"]),a(Ae,{"model-value":e(he),flat:"",variant:"solo-filled",label:e(t)("models.manualDialogPreviewLabel"),"persistent-hint":"",hint:e(t)("models.manualDialogPreviewHint")},null,8,["model-value","label","hint"])]),_:1}),a(Le,{class:"pa-4"},{default:s(()=>[a(Be),a(P,{variant:"text",onClick:p[2]||(p[2]=n=>J.value=!1)},{default:s(()=>[h("取消")]),_:1}),a(P,{color:"primary",onClick:$e},{default:s(()=>[h("添加")]),_:1})]),_:1})]),_:1},8,["title"])]),_:1},8,["modelValue"]),a(te,{modelValue:q.value,"onUpdate:modelValue":p[5]||(p[5]=n=>q.value=n),width:"800"},{default:s(()=>{var n;return[a(Y,{title:((n=D.value)==null?void 0:n.id)||e(t)("dialogs.config.editTitle")},{default:s(()=>[a(ae,{class:"py-4"},{default:s(()=>[Ya,D.value?(v(),z(Ee,{key:0,iterable:D.value,metadata:e(E),metadataKey:"provider","is-editing":!0},null,8,["iterable","metadata"])):k("",!0)]),_:1}),a(Le,{class:"pa-4"},{default:s(()=>{var U,R;return[a(Be),a(P,{variant:"text",onClick:p[4]||(p[4]=He=>q.value=!1),disabled:K.value.includes((U=D.value)==null?void 0:U.id)},{default:s(()=>[h(S(e(t)("dialogs.config.cancel")),1)]),_:1},8,["disabled"]),a(P,{color:"primary",onClick:Re,loading:K.value.includes((R=D.value)==null?void 0:R.id)},{default:s(()=>[h(S(e(t)("dialogs.config.save")),1)]),_:1},8,["loading"])]}),_:1})]),_:1},8,["title"])]}),_:1},8,["modelValue"])]),_:1},8,["modelValue","max-width","fullscreen"]))}},Ga=We(Za,[["__scopeId","data-v-55280f9c"]]),Xa={key:0,class:"sidebar-collapse-btn-container"},es={key:1,class:"sidebar-collapse-btn-container"},as={style:{padding:"8px",opacity:"0.6"}},ss={key:2,style:{"overflow-y":"auto","flex-grow":"1"}},os={class:"conversation-actions"},ls={key:0,class:"no-conversations"},ts={key:0,class:"no-conversations-text"},is={key:3,class:"sidebar-spacer"},ns={class:"sidebar-footer"},rs=Ge({__name:"ConversationSidebar",props:{sessions:{},selectedSessions:{},currSessionId:{},isDark:{type:Boolean},chatboxMode:{type:Boolean},isMobile:{type:Boolean},mobileMenuOpen:{type:Boolean}},emits:["newChat","selectConversation","editTitle","deleteConversation","closeMobileSidebar","toggleTheme","toggleFullscreen"],setup(x,{emit:A}){const{t:w}=Xe(),{tm:t}=ze("features/chat"),l=b(!0),C=b(!1),$=localStorage.getItem("sidebarCollapsed");$!==null?l.value=JSON.parse($):l.value=!0;function I(){l.value=!l.value,localStorage.setItem("sidebarCollapsed",JSON.stringify(l.value))}function y(o){const m=o.display_name||t("conversation.newConversation"),d=t("conversation.confirmDelete",{name:m});window.confirm(d)&&A("deleteConversation",o.session_id)}return(o,m)=>(v(),M("div",{class:Q(["sidebar-panel",{"sidebar-collapsed":l.value&&!o.isMobile,"mobile-sidebar-open":o.isMobile&&o.mobileMenuOpen,"mobile-sidebar":o.isMobile}]),style:X({"background-color":o.isDark?l.value?"#1e1e1e":"#2d2d2d":l.value?"#ffffff":"#f1f4f9"})},[o.isMobile?k("",!0):(v(),M("div",Xa,[a(P,{icon:"",class:"sidebar-collapse-btn",onClick:I,variant:"text",color:"deep-purple"},{default:s(()=>[a(L,null,{default:s(()=>[h(S(l.value?"mdi-chevron-right":"mdi-chevron-left"),1)]),_:1})]),_:1})])),o.isMobile?(v(),M("div",es,[a(P,{icon:"",class:"sidebar-collapse-btn",onClick:m[0]||(m[0]=d=>o.$emit("closeMobileSidebar")),variant:"text",color:"deep-purple"},{default:s(()=>[a(L,null,{default:s(()=>[h("mdi-close")]),_:1})]),_:1})])):k("",!0),g("div",as,[!l.value||o.isMobile?(v(),z(P,{key:0,block:"",variant:"text",class:"new-chat-btn",onClick:m[1]||(m[1]=d=>o.$emit("newChat")),disabled:!o.currSessionId,"prepend-icon":"mdi-square-edit-outline"},{default:s(()=>[h(S(e(t)("actions.newChat")),1)]),_:1},8,["disabled"])):k("",!0),l.value&&!o.isMobile?(v(),z(P,{key:1,icon:"mdi-square-edit-outline",rounded:"xl",onClick:m[2]||(m[2]=d=>o.$emit("newChat")),disabled:!o.currSessionId,elevation:"0"},null,8,["disabled"])):k("",!0)]),!l.value||o.isMobile?(v(),M("div",ss,[o.sessions.length>0?(v(),z(Y,{key:0,flat:"",style:{"background-color":"transparent"}},{default:s(()=>[a(ya,{density:"compact",nav:"",class:"conversation-list",style:{"background-color":"transparent"},selected:o.selectedSessions,"onUpdate:selected":m[3]||(m[3]=d=>o.$emit("selectConversation",d))},{default:s(()=>[(v(!0),M(Ne,null,ha(o.sessions,d=>(v(),z(oe,{key:d.session_id,value:d.session_id,rounded:"lg",class:"conversation-item","active-color":"secondary"},ba({default:s(()=>[!l.value||o.isMobile?(v(),z(le,{key:0,class:"conversation-title",style:X({color:o.isDark?"#ffffff":"#000000"})},{default:s(()=>[h(S(d.display_name||e(t)("conversation.newConversation")),1)]),_:2},1032,["style"])):k("",!0)]),_:2},[!l.value||o.isMobile?{name:"append",fn:s(()=>[g("div",os,[a(P,{icon:"mdi-pencil",size:"x-small",variant:"text",class:"edit-title-btn",onClick:Ke(B=>o.$emit("editTitle",d.session_id,d.display_name??""),["stop"])},null,8,["onClick"]),a(P,{icon:"mdi-delete",size:"x-small",variant:"text",class:"delete-conversation-btn",color:"error",onClick:Ke(B=>y(d),["stop"])},null,8,["onClick"])])]),key:"0"}:void 0]),1032,["value"]))),128))]),_:1},8,["selected"])]),_:1})):k("",!0),a(_a,null,{default:s(()=>[o.sessions.length===0?(v(),M("div",ls,[a(L,{icon:"mdi-message-text-outline",size:"large",color:"grey-lighten-1"}),!l.value||o.isMobile?(v(),M("div",ts,S(e(t)("conversation.noHistory")),1)):k("",!0)])):k("",!0)]),_:1})])):k("",!0),l.value&&!o.isMobile?(v(),M("div",is)):k("",!0),g("div",ns,[a(xa,{location:"top","close-on-content-click":!1},{activator:s(({props:d})=>[a(P,Sa(d,{icon:l.value&&!o.isMobile,block:!l.value||o.isMobile,variant:"text",class:["settings-btn",{"settings-btn-collapsed":l.value&&!o.isMobile}],"prepend-icon":!l.value||o.isMobile?"mdi-cog-outline":void 0}),{default:s(()=>[l.value&&!o.isMobile?(v(),z(L,{key:0},{default:s(()=>[h("mdi-cog-outline")]),_:1})):k("",!0),!l.value||o.isMobile?(v(),M(Ne,{key:1},[h(S(e(w)("core.common.settings")),1)],64)):k("",!0)]),_:2},1040,["icon","block","class","prepend-icon"])]),default:s(()=>[a(oe,{class:"styled-menu-item"},{prepend:s(()=>[a(L,null,{default:s(()=>[h("mdi-translate")]),_:1})]),append:s(()=>[a(Ta,{variant:"chatbox"})]),default:s(()=>[a(le,null,{default:s(()=>[h(S(e(w)("core.common.language")),1)]),_:1})]),_:1}),a(oe,{class:"styled-menu-item",onClick:m[4]||(m[4]=d=>o.$emit("toggleTheme"))},{prepend:s(()=>[a(L,null,{default:s(()=>[h(S(o.isDark?"mdi-weather-night":"mdi-white-balance-sunny"),1)]),_:1})]),default:s(()=>[a(le,null,{default:s(()=>[h(S(o.isDark?e(t)("modes.lightMode"):e(t)("modes.darkMode")),1)]),_:1})]),_:1}),a(oe,{class:"styled-menu-item",onClick:m[5]||(m[5]=d=>o.$emit("toggleFullscreen"))},{prepend:s(()=>[a(L,null,{default:s(()=>[h(S(o.chatboxMode?"mdi-fullscreen-exit":"mdi-fullscreen"),1)]),_:1})]),default:s(()=>[a(le,null,{default:s(()=>[h(S(o.chatboxMode?e(t)("actions.exitFullscreen"):e(t)("actions.fullscreen")),1)]),_:1})]),_:1}),a(oe,{class:"styled-menu-item",onClick:m[6]||(m[6]=d=>C.value=!0)},{prepend:s(()=>[a(L,null,{default:s(()=>[h("mdi-creation")]),_:1})]),default:s(()=>[a(le,null,{default:s(()=>[h(S(e(t)("actions.providerConfig")),1)]),_:1})]),_:1})]),_:1})]),a(Ga,{modelValue:C.value,"onUpdate:modelValue":m[7]||(m[7]=d=>C.value=d)},null,8,["modelValue"])],6))}});const ds=We(rs,[["__scopeId","data-v-21f0d7c5"]]);function us(x=!1){const A=ea(),w=b([]),t=b([]),l=b(""),C=b(null),$=b(!1),I=b(""),y=b(""),o=Oe(()=>l.value?w.value.find(c=>c.session_id===l.value):null);async function m(){var c;try{const f=await ee.get("/api/chat/sessions");if(w.value=f.data.data,C.value)w.value.find(N=>N.session_id===C.value)&&(t.value=[C.value],C.value=null);else if(l.value)w.value.find(N=>N.session_id===l.value)&&(t.value=[l.value]);else if(w.value.length>0){const V=w.value[0];t.value=[V.session_id]}}catch(f){((c=f.response)==null?void 0:c.status)===401&&A.push("/auth/login?redirect=/chatbox"),console.error(f)}}async function d(){try{const f=(await ee.get("/api/chat/new_session")).data.data.session_id;l.value=f;const V=x?"/chatbox":"/chat";return A.push(`${V}/${f}`),await m(),t.value=[f],f}catch(c){throw console.error(c),c}}async function B(c){try{await ee.get("/api/chat/delete_session?session_id="+c),await m(),l.value="",t.value=[]}catch(f){console.error(f)}}function H(c,f){y.value=c,I.value=f||"",$.value=!0}async function T(){if(!y.value)return;const c=I.value.trim();try{await ee.post("/api/chat/update_session_display_name",{session_id:y.value,display_name:c});const f=w.value.find(V=>V.session_id===y.value);f&&(f.display_name=c),$.value=!1}catch(f){console.error("重命名会话失败:",f)}}function E(c,f){const V=w.value.find(N=>N.session_id===c);V&&(V.display_name=f)}function F(c){l.value="",t.value=[];const f=x?"/chatbox":"/chat";A.push(f),c&&c()}return{sessions:w,selectedSessions:t,currSessionId:l,pendingSessionId:C,editTitleDialog:$,editingTitle:I,editingSessionId:y,getCurrentSession:o,getSessions:m,newSession:d,deleteSession:B,showEditTitleDialog:H,saveTitle:T,updateSessionTitle:E,newChat:F}}const aa=x=>(Ye("data-v-8aae55e3"),x=x(),Ze(),x),cs={class:"chat-layout"},vs={class:"chat-content-panel"},ms={key:0,class:"conversation-header fade-in"},ps={key:1,class:"message-list-wrapper"},fs={key:2,class:"welcome-container fade-in"},gs={key:0,class:"loading-overlay-welcome"},hs={key:1,class:"welcome-title"},bs=aa(()=>g("span",null,"Hello, I'm",-1)),ys=aa(()=>g("span",{class:"bot-name"},"AstrBot ⭐",-1)),_s=[bs,ys],Ss=["src"],ws=Ge({__name:"Chat",props:{chatboxMode:{type:Boolean,default:!1}},setup(x){const A=x,w=ea(),t=wa(),{t:l}=Xe(),{tm:C}=ze("features/chat"),$=Ma(),I=b(!1),y=b(!1),o=b(!1),m=b(""),d=b(!1),{sessions:B,selectedSessions:H,currSessionId:T,pendingSessionId:E,editTitleDialog:F,editingTitle:c,editingSessionId:f,getCurrentSession:V,getSessions:N,newSession:ie,deleteSession:ne,showEditTitleDialog:he,saveTitle:re,updateSessionTitle:be,newChat:ye}=us(A.chatboxMode),{stagedImagesUrl:_e,stagedAudioUrl:Z,stagedFiles:de,stagedNonImageFiles:Se,getMediaFile:we,processAndUploadImage:Me,processAndUploadFile:Ce,handlePaste:ke,removeImage:ue,removeAudio:Pe,removeFile:Te,clearStaged:se,cleanupMediaCache:xe}=Ra(),{isRecording:J,startRecording:q,stopRecording:D}=Ea(),{messages:j,isStreaming:K,isConvRunning:Ie,enableStreaming:Ve,getSessionMessages:$e,sendMessage:De,toggleStreaming:Re}=Fa(T,we,be,N),ce=b(null),_=b(null),p=b(""),n=b(null),U=Oe(()=>Je().uiTheme==="PurpleThemeDark");function R(){I.value=window.innerWidth<=768,I.value||(y.value=!1)}function He(){y.value=!y.value}function ve(){y.value=!1}function sa(){const i=Je(),r=i.uiTheme==="PurpleTheme"?"PurpleThemeDark":"PurpleTheme";i.SET_UI_THEME(r),$.global.name.value=r}function oa(){A.chatboxMode?w.push(T.value?`/chat/${T.value}`:"/chat"):w.push(T.value?`/chatbox/${T.value}`:"/chatbox")}function la(i){m.value=i,o.value=!0}function ta(i,r){const u=i.id;if(!u){console.warn("Message does not have an id");return}let O="";typeof i.content.message=="string"?O=i.content.message:Array.isArray(i.content.message)&&(O=i.content.message.filter(G=>G.type==="plain"&&G.text).map(G=>G.text).join("")),O.length>100&&(O=O.substring(0,100)+"..."),n.value={messageId:u,messageContent:O||"[媒体内容]"}}function me(){n.value=null}async function pe(i){if(!i[0])return;T.value=i[0],H.value=[i[0]];const r=A.chatboxMode?"/chatbox":"/chat";t.path!==`${r}/${i[0]}`&&w.push(`${r}/${i[0]}`),I.value&&ve(),me(),d.value=!0;try{await $e(i[0])}finally{d.value=!1}Pa(()=>{var u;(u=ce.value)==null||u.scrollToBottom()})}function ia(){ye(ve),j.value=[],me()}async function na(i){await ne(i),j.value=[]}async function ra(){await q()}async function da(){const i=await D();Z.value=i}async function ua(i){const r=["image/jpeg","image/png","image/gif","image/webp"];for(const u of i)r.includes(u.type)?await Me(u):await Ce(u)}async function ca(){var je;if(!p.value.trim()&&de.value.length===0&&!Z.value)return;T.value||await ie();const i=p.value.trim(),r=Z.value,u=de.value.map(fe=>({attachment_id:fe.attachment_id,url:fe.url,original_name:fe.original_name,type:fe.type})),O=n.value?{...n.value}:null;p.value="",se(),me();const W=(je=_.value)==null?void 0:je.getCurrentSelection(),G=(W==null?void 0:W.providerId)||"",va=(W==null?void 0:W.modelName)||"";await De(i,u,r,G,va,O)}return Fe(()=>t.path,(i,r)=>{if(!(r&&(r.startsWith("/chat")&&i.startsWith("/chatbox")||r.startsWith("/chatbox")&&i.startsWith("/chat")))&&(i.startsWith("/chat/")||i.startsWith("/chatbox/"))){const u=i.split("/")[2];u&&u!==T.value&&(B.value.length>0?B.value.find(W=>W.session_id===u)&&pe([u]):E.value=u)}},{immediate:!0}),Fe(B,i=>{if(E.value&&i.length>0)i.find(u=>u.session_id===E.value)&&(H.value=[E.value],pe([E.value]),E.value=null);else if(!T.value&&i.length>0){const r=i[0];H.value=[r.session_id],pe([r.session_id])}}),qe(()=>{R(),window.addEventListener("resize",R),N()}),Qe(()=>{window.removeEventListener("resize",R),xe()}),(i,r)=>(v(),M(Ne,null,[a(Y,{class:"chat-page-card",elevation:"0",rounded:"0"},{default:s(()=>[a(ae,{class:"chat-page-container"},{default:s(()=>[I.value&&y.value?(v(),M("div",{key:0,class:"mobile-overlay",onClick:ve})):k("",!0),g("div",cs,[a(ds,{sessions:e(B),selectedSessions:e(H),currSessionId:e(T),isDark:U.value,chatboxMode:i.chatboxMode,isMobile:I.value,mobileMenuOpen:y.value,onNewChat:ia,onSelectConversation:pe,onEditTitle:e(he),onDeleteConversation:na,onCloseMobileSidebar:ve,onToggleTheme:sa,onToggleFullscreen:oa},null,8,["sessions","selectedSessions","currSessionId","isDark","chatboxMode","isMobile","mobileMenuOpen","onEditTitle"]),g("div",vs,[I.value?(v(),M("div",ms,[a(P,{icon:"",class:"mobile-menu-btn",onClick:He,variant:"text"},{default:s(()=>[a(L,null,{default:s(()=>[h("mdi-menu")]),_:1})]),_:1})])):k("",!0),e(j)&&e(j).length>0?(v(),M("div",ps,[a(Ia,{messages:e(j),isDark:U.value,isStreaming:e(K)||e(Ie),isLoadingMessages:d.value,onOpenImagePreview:la,onReplyMessage:ta,ref_key:"messageList",ref:ce},null,8,["messages","isDark","isStreaming","isLoadingMessages"]),g("div",{class:Q(["message-list-fade",{"fade-dark":U.value}])},null,2)])):(v(),M("div",fs,[d.value?(v(),M("div",gs,[a(Ca,{indeterminate:"",size:"48",width:"4",color:"primary"})])):(v(),M("div",hs,_s))])),a(Ua,{prompt:p.value,"onUpdate:prompt":r[0]||(r[0]=u=>p.value=u),stagedImagesUrl:e(_e),stagedAudioUrl:e(Z),stagedFiles:e(Se),disabled:e(K),enableStreaming:e(Ve),isRecording:e(J),"session-id":e(T)||null,"current-session":e(V),replyTo:n.value,onSend:ca,onToggleStreaming:e(Re),onRemoveImage:e(ue),onRemoveAudio:e(Pe),onRemoveFile:e(Te),onStartRecording:ra,onStopRecording:da,onPasteImage:e(ke),onFileSelect:ua,onClearReply:me,ref_key:"chatInputRef",ref:_},null,8,["prompt","stagedImagesUrl","stagedAudioUrl","stagedFiles","disabled","enableStreaming","isRecording","session-id","current-session","replyTo","onToggleStreaming","onRemoveImage","onRemoveAudio","onRemoveFile","onPasteImage"])])])]),_:1})]),_:1}),a(te,{modelValue:e(F),"onUpdate:modelValue":r[3]||(r[3]=u=>ge(F)?F.value=u:null),"max-width":"400"},{default:s(()=>[a(Y,null,{default:s(()=>[a(Ue,{class:"dialog-title"},{default:s(()=>[h(S(e(C)("actions.editTitle")),1)]),_:1}),a(ae,null,{default:s(()=>[a(Ae,{modelValue:e(c),"onUpdate:modelValue":r[1]||(r[1]=u=>ge(c)?c.value=u:null),label:e(C)("conversation.newConversation"),variant:"outlined","hide-details":"",class:"mt-2",onKeyup:ka(e(re),["enter"]),autofocus:""},null,8,["modelValue","label","onKeyup"])]),_:1}),a(Le,null,{default:s(()=>[a(Be),a(P,{variant:"text",onClick:r[2]||(r[2]=u=>F.value=!1),color:"grey-darken-1"},{default:s(()=>[h(S(e(l)("core.common.cancel")),1)]),_:1}),a(P,{variant:"text",onClick:e(re),color:"primary"},{default:s(()=>[h(S(e(l)("core.common.save")),1)]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(te,{modelValue:o.value,"onUpdate:modelValue":r[5]||(r[5]=u=>o.value=u),"max-width":"90vw","max-height":"90vh"},{default:s(()=>[a(Y,{class:"image-preview-card",elevation:"8"},{default:s(()=>[a(Ue,{class:"d-flex justify-space-between align-center pa-4"},{default:s(()=>[g("span",null,S(e(l)("core.common.imagePreview")),1),a(P,{icon:"mdi-close",variant:"text",onClick:r[4]||(r[4]=u=>o.value=!1)})]),_:1}),a(ae,{class:"text-center pa-4"},{default:s(()=>[g("img",{src:m.value,class:"preview-image-large"},null,8,Ss)]),_:1})]),_:1})]),_:1},8,["modelValue"])],64))}});const Vs=We(ws,[["__scopeId","data-v-8aae55e3"]]);export{Vs as C};
