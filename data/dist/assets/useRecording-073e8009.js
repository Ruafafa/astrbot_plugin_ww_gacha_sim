import{T as ge,v,c as D,x as Te,M as ve,o as b,g as M,b as i,w as u,k as se,m as ae,l as H,e as V,t as Z,ap as le,y as be,z as Le,B as Y,C as Ce,E as we,a as X,F as ue,h as de,V as ke,p as W,d as Se,q as xe,O as Ie,H as $e,I as Ve,J as Ee,K as q,R as Me,S as ze,A as G,a5 as Oe,as as De,ae as Ae,aQ as Pe,$ as Fe,bg as Be,f as oe,s as je,av as re}from"./index-61371d60.js";import{useCustomizerStore as Ne}from"./customizer-e056107a.js";import{u as Re}from"./AstrBotConfig-27eff76a.js";import{_ as ye}from"./_plugin-vue_export-helper-c27b6911.js";const Ke=S=>(Me("data-v-8096aebc"),S=S(),ze(),S),Ge=Ke(()=>G("span",null,"选择配置文件",-1)),Je={key:0,class:"text-center py-6"},We={key:0,class:"text-center text-body-2 text-medium-emphasis"},ce="chat.selectedConfigId",He=ge({__name:"ConfigSelector",props:{sessionId:{default:null},platformId:{default:"webchat"},isGroup:{type:Boolean,default:!1},initialConfigId:{default:null}},emits:["config-changed"],setup(S,{emit:y}){const r=S,d=v([]),c=v(!1),C=v(!1),h=v(""),k=v("default"),z=v("local"),w=v(!1),L=v(!1),I=v([]),A=v({}),N=Re(),s=D(()=>{var g;const l=(g=r.sessionId)==null?void 0:g.trim();return l||null});D(()=>!!s.value);const m=D(()=>r.isGroup?"GroupMessage":"FriendMessage"),t=D(()=>localStorage.getItem("user")||"guest"),e=D(()=>s.value?`${r.platformId}!${t.value}!${s.value}`:null),n=D(()=>e.value?`${r.platformId}:${m.value}:${e.value}`:null),o=D(()=>{const l=d.value.find(g=>g.id===k.value);return(l==null?void 0:l.name)||k.value||"default"});function E(){h.value=k.value,C.value=!0}function J(){C.value=!1}async function P(){var l;c.value=!0;try{const g=await q.get("/api/config/abconfs");d.value=((l=g.data.data)==null?void 0:l.info_list)||[]}catch(g){console.error("加载配置文件列表失败",g),d.value=[]}finally{c.value=!1}}async function ee(){var l;try{const _=((l=(await q.get("/api/config/umo_abconf_routes")).data.data)==null?void 0:l.routing)||{};I.value=Object.entries(_).map(([x,p])=>({pattern:x,confId:p}))}catch(g){console.error("获取配置路由失败",g),I.value=[]}}function a(l,g){const _=l.split(":"),x=g.split(":");return _.length!==3||x.length!==3?!1:_.every((p,O)=>p===""||p==="*"||p===x[O])}function R(l){if(!l)return"default";for(const g of I.value)if(a(g.pattern,l))return g.confId;return"default"}async function U(l){var g,_,x;if(A.value[l])return A.value[l];try{const O=((x=(_=(g=(await q.get("/api/config/abconf",{params:{id:l}})).data.data)==null?void 0:g.config)==null?void 0:_.provider_settings)==null?void 0:x.agent_runner_type)||"local";return A.value[l]=O,O}catch(p){return console.error("获取配置文件详情失败",p),"local"}}async function F(l){const g=l||"default";k.value=g;const _=await U(g);z.value=_,y("config-changed",{configId:g,agentRunnerType:_})}async function te(l){var g,_;if(!n.value)return L.value=!0,!0;w.value=!0;try{await q.post("/api/config/umo_abconf_route/update",{umo:n.value,conf_id:l});const x=I.value.filter(p=>p.pattern!==n.value);return x.push({pattern:n.value,confId:l}),I.value=x,!0}catch(x){const p=x;return console.error("更新配置文件失败",p),N.error(((_=(g=p==null?void 0:p.response)==null?void 0:g.data)==null?void 0:_.message)||"配置文件应用失败"),!1}finally{w.value=!1}}async function K(){if(!h.value)return;const l=k.value;await F(h.value),localStorage.setItem(ce,h.value),await te(h.value)||(localStorage.setItem(ce,l),await F(l)),C.value=!1}async function B(){if(!n.value){L.value=!0;return}if(L.value){L.value=!1,await te(k.value);return}await ee();const l=R(n.value);await F(l),localStorage.setItem(ce,l)}return Te(()=>[r.sessionId,r.platformId,r.isGroup],async()=>{await B()}),ve(async()=>{await P();const l=r.initialConfigId||localStorage.getItem(ce)||"default";k.value=l,await F(l),await B()}),(l,g)=>(b(),M("div",null,[i(le,{text:"选择用于当前会话的配置文件",location:"top"},{activator:u(({props:_})=>[i(se,ae(_,{class:"text-none config-chip",variant:"tonal",size:"x-small",rounded:"lg",onClick:E,disabled:c.value||w.value}),{default:u(()=>[i(H,{start:"",size:"14"},{default:u(()=>[V("mdi-cog")]),_:1}),V(" "+Z(o.value),1)]),_:2},1040,["disabled"])]),_:1}),i(Ee,{modelValue:C.value,"onUpdate:modelValue":g[0]||(g[0]=_=>C.value=_),"max-width":"480"},{default:u(()=>[i(be,null,{default:u(()=>[i(Le,{class:"d-flex align-center justify-space-between"},{default:u(()=>[Ge,i(Y,{icon:"",variant:"text",onClick:J},{default:u(()=>[i(H,null,{default:u(()=>[V("mdi-close")]),_:1})]),_:1})]),_:1}),i(Ce,null,{default:u(()=>[c.value?(b(),M("div",Je,[i(we,{indeterminate:"",color:"primary"})])):(b(),X(Ie,{key:1,class:"config-list",density:"comfortable"},{default:u(()=>[(b(!0),M(ue,null,de(d.value,_=>(b(),X(ke,{key:_.id,active:h.value===_.id,rounded:"lg",variant:"text",onClick:x=>h.value=_.id},{append:u(()=>[h.value===_.id?(b(),X(H,{key:0,color:"primary"},{default:u(()=>[V("mdi-check")]),_:1})):W("",!0)]),default:u(()=>[i(Se,null,{default:u(()=>[V(Z(_.name),1)]),_:2},1024),i(xe,{class:"text-caption text-grey"},{default:u(()=>[V(Z(_.id),1)]),_:2},1024)]),_:2},1032,["active","onClick"]))),128)),d.value.length===0?(b(),M("div",We," 暂无可选配置，请先在配置页创建。 ")):W("",!0)]),_:1}))]),_:1}),i($e,null,{default:u(()=>[i(Ve),i(Y,{variant:"text",onClick:J},{default:u(()=>[V("取消")]),_:1}),i(Y,{color:"primary",onClick:K,disabled:!h.value,loading:w.value},{default:u(()=>[V(" 应用 ")]),_:1},8,["disabled","loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]))}});const qe=ye(He,[["__scopeId","data-v-8096aebc"]]),Qe={key:0},Ye={key:1},Xe={class:"model-name"},Ze={class:"meta-icons"},et={key:0,class:"empty-hint"},tt=ge({__name:"ProviderModelMenu",setup(S,{expose:y}){const r=v([]),d=v(""),c=v(""),C=v(!1),h=D(()=>{if(!c.value)return r.value;const t=c.value.toLowerCase();return r.value.filter(e=>e.id.toLowerCase().includes(t)||e.model.toLowerCase().includes(t))});function k(){const t=localStorage.getItem("selectedProvider");t&&(d.value=t)}function z(){d.value&&localStorage.setItem("selectedProvider",d.value)}function w(){q.get("/api/config/provider/list",{params:{provider_type:"chat_completion"}}).then(t=>{t.data.status==="ok"&&(r.value=(t.data.data||[]).filter(e=>e.enable!==!1))}).catch(t=>{console.error("获取提供商列表失败:",t)})}function L(t){d.value=t.id,z()}function I(t){var n,o;return(((o=(n=t.model_metadata)==null?void 0:n.modalities)==null?void 0:o.input)||[]).includes("image")}function A(t){var e;return!!((e=t.model_metadata)!=null&&e.tool_call)}function N(t){var e;return!!((e=t.model_metadata)!=null&&e.reasoning)}function s(){const t=r.value.find(e=>e.id===d.value);return{providerId:d.value,modelName:(t==null?void 0:t.model)||""}}function m(t){t&&w()}return ve(()=>{k(),w()}),y({getCurrentSelection:s}),(t,e)=>(b(),X(De,{modelValue:C.value,"onUpdate:modelValue":[e[1]||(e[1]=n=>C.value=n),m],"close-on-content-click":!1,location:"top"},{activator:u(({props:n})=>[i(se,ae(n,{class:"text-none provider-chip",variant:"tonal",size:"x-small"}),{default:u(()=>[i(H,{start:"",size:"14"},{default:u(()=>[V("mdi-creation")]),_:1}),d.value?(b(),M("span",Qe,Z(d.value),1)):(b(),M("span",Ye,"Model"))]),_:2},1040)]),default:u(()=>[i(be,{class:"provider-menu-card","min-width":"280","max-width":"400"},{default:u(()=>[i(Ce,{class:"pa-2"},{default:u(()=>[i(Oe,{modelValue:c.value,"onUpdate:modelValue":e[0]||(e[0]=n=>c.value=n),placeholder:"Search...","hide-details":"",variant:"plain",flat:"",density:"compact","prepend-inner-icon":"mdi-magnify",class:"ml-2 mb-2 mr-2",clearable:""},null,8,["modelValue"]),i(Ie,{density:"compact",nav:"",class:"provider-menu-list"},{default:u(()=>[(b(!0),M(ue,null,de(h.value,n=>(b(),X(ke,{key:n.id,active:d.value===n.id,onClick:o=>L(n),rounded:"lg",class:"provider-menu-item"},{default:u(()=>[i(Se,{class:"text-body-2"},{default:u(()=>[V(Z(n.id),1)]),_:2},1024),i(xe,{class:"provider-subtitle"},{default:u(()=>[G("span",Xe,Z(n.model),1),G("span",Ze,[I(n)?(b(),X(le,{key:0,text:"支持图像输入",location:"top"},{activator:u(({props:o})=>[i(H,ae(o,{size:"12",color:"grey"}),{default:u(()=>[V("mdi-eye-outline")]),_:2},1040)]),_:1})):W("",!0),A(n)?(b(),X(le,{key:1,text:"支持工具调用",location:"top"},{activator:u(({props:o})=>[i(H,ae(o,{size:"12",color:"grey"}),{default:u(()=>[V("mdi-wrench")]),_:2},1040)]),_:1})):W("",!0),N(n)?(b(),X(le,{key:2,text:"支持推理",location:"top"},{activator:u(({props:o})=>[i(H,ae(o,{size:"12",color:"grey"}),{default:u(()=>[V("mdi-brain")]),_:2},1040)]),_:1})):W("",!0)])]),_:2},1024)]),_:2},1032,["active","onClick"]))),128))]),_:1}),r.value.length===0?(b(),M("div",et," No available models ")):W("",!0)]),_:1})]),_:1})]),_:1},8,["modelValue"]))}});const at=ye(tt,[["__scopeId","data-v-7de03738"]]),nt={class:"input-area fade-in"},ot={key:0,class:"reply-preview"},st={class:"reply-content"},lt={class:"reply-text"},it=["disabled"],rt={style:{display:"flex","justify-content":"space-between","align-items":"center",padding:"6px 14px"}},ct={style:{display:"flex","justify-content":"flex-start","margin-top":"4px","align-items":"center",gap:"8px"}},ut={style:{display:"flex","justify-content":"flex-end","margin-top":"8px","align-items":"center"}},dt={key:0,class:"attachments-preview"},pt=["src"],ft={key:0,class:"audio-preview"},mt={class:"file-name-preview"},gt=300,vt=ge({__name:"ChatInput",props:{prompt:{},stagedImagesUrl:{},stagedAudioUrl:{},stagedFiles:{default:()=>[]},disabled:{type:Boolean},enableStreaming:{type:Boolean},isRecording:{type:Boolean},sessionId:{default:null},currentSession:{default:null},configId:{default:null},replyTo:{default:null}},emits:["update:prompt","send","toggleStreaming","removeImage","removeAudio","removeFile","startRecording","stopRecording","pasteImage","fileSelect","clearReply"],setup(S,{expose:y,emit:r}){const d=S,{tm:c}=Ae("features/chat"),C=D(()=>Ne().uiTheme==="PurpleThemeDark"),h=v(null),k=v(null),z=v(null),w=v(!0),L=D({get:()=>d.prompt,set:a=>r("update:prompt",a)}),I=D(()=>{var a;return((a=d.currentSession)==null?void 0:a.platform_id)||"webchat"}),A=D(()=>{var a;return!!((a=d.currentSession)!=null&&a.is_group)}),N=D(()=>d.prompt&&d.prompt.trim()||d.stagedImagesUrl.length>0||d.stagedAudioUrl||d.stagedFiles&&d.stagedFiles.length>0),s=v(!1),m=v(null);function t(a){if(a.keyCode===13&&!a.shiftKey&&(a.preventDefault(),N.value&&r("send")),a.ctrlKey&&a.keyCode===66){if(a.preventDefault(),s.value)return;s.value=!0,m.value=window.setTimeout(()=>{s.value&&!d.isRecording&&r("startRecording")},gt)}}function e(a){a.keyCode===66&&(s.value=!1,m.value&&(clearTimeout(m.value),m.value=null),d.isRecording&&r("stopRecording"))}function n(a){r("pasteImage",a)}function o(){var a;(a=k.value)==null||a.click()}function E(a){const R=a.target,U=R.files;U&&r("fileSelect",U),R.value=""}function J(){d.isRecording?r("stopRecording"):r("startRecording")}function P(a){const R=(a.agentRunnerType||"").toLowerCase(),U=R==="internal"||R==="local";w.value=U}function ee(){var a;return w.value?(a=z.value)==null?void 0:a.getCurrentSelection():null}return ve(()=>{h.value&&h.value.addEventListener("paste",n),document.addEventListener("keyup",e)}),Pe(()=>{h.value&&h.value.removeEventListener("paste",n),document.removeEventListener("keyup",e)}),y({getCurrentSelection:ee}),(a,R)=>(b(),M("div",nt,[G("div",{class:"input-container",style:je({width:"85%",maxWidth:"900px",margin:"0 auto",border:C.value?"none":"1px solid #e0e0e0",borderRadius:"24px",boxShadow:C.value?"none":"0px 2px 2px rgba(0, 0, 0, 0.1)",backgroundColor:C.value?"#2d2d2d":"transparent"})},[d.replyTo?(b(),M("div",ot,[G("div",st,[i(H,{size:"small",class:"reply-icon"},{default:u(()=>[V("mdi-reply")]),_:1}),V(' "'),G("span",lt,Z(d.replyTo.messageContent),1),V('" ')]),i(Y,{onClick:R[0]||(R[0]=U=>a.$emit("clearReply")),class:"remove-reply-btn",icon:"mdi-close",size:"x-small",color:"grey",variant:"text"})])):W("",!0),Fe(G("textarea",{ref_key:"inputField",ref:h,"onUpdate:modelValue":R[1]||(R[1]=U=>L.value=U),onKeydown:t,disabled:a.disabled,placeholder:"Ask AstrBot...",style:{width:"100%",resize:"none",outline:"none",border:"1px solid var(--v-theme-border)","border-radius":"12px",padding:"12px 16px","min-height":"40px","font-family":"inherit","font-size":"16px","background-color":"var(--v-theme-surface)"}},null,40,it),[[Be,L.value]]),G("div",rt,[G("div",ct,[i(qe,{"session-id":a.sessionId||null,"platform-id":I.value,"is-group":A.value,"initial-config-id":d.configId,onConfigChanged:P},null,8,["session-id","platform-id","is-group","initial-config-id"]),w.value?(b(),X(at,{key:0,ref_key:"providerModelMenuRef",ref:z},null,512)):W("",!0),i(le,{text:a.enableStreaming?oe(c)("streaming.enabled"):oe(c)("streaming.disabled"),location:"top"},{activator:u(({props:U})=>[i(se,ae(U,{onClick:R[2]||(R[2]=F=>a.$emit("toggleStreaming")),size:"x-small",class:"streaming-toggle-chip"}),{default:u(()=>[i(H,{start:"",icon:a.enableStreaming?"mdi-flash":"mdi-flash-off",size:"small"},null,8,["icon"]),V(" "+Z(a.enableStreaming?oe(c)("streaming.on"):oe(c)("streaming.off")),1)]),_:2},1040)]),_:1},8,["text"])]),G("div",ut,[G("input",{type:"file",ref_key:"imageInputRef",ref:k,onChange:E,style:{display:"none"},multiple:""},null,544),a.disabled?(b(),X(we,{key:0,indeterminate:"",size:"16",class:"mr-1",width:"1.5"})):W("",!0),i(Y,{onClick:o,icon:"mdi-plus",variant:"text",color:"deep-purple",class:"add-btn",size:"small"}),i(Y,{onClick:J,icon:a.isRecording?"mdi-stop-circle":"mdi-microphone",variant:"text",color:a.isRecording?"error":"deep-purple",class:"record-btn",size:"small"},null,8,["icon","color"]),i(Y,{onClick:R[3]||(R[3]=U=>a.$emit("send")),icon:"mdi-send",variant:"text",color:"deep-purple",disabled:!N.value,class:"send-btn",size:"small"},null,8,["disabled"])])])],4),a.stagedImagesUrl.length>0||a.stagedAudioUrl||a.stagedFiles&&a.stagedFiles.length>0?(b(),M("div",dt,[(b(!0),M(ue,null,de(a.stagedImagesUrl,(U,F)=>(b(),M("div",{key:"img-"+F,class:"image-preview"},[G("img",{src:U,class:"preview-image"},null,8,pt),i(Y,{onClick:te=>a.$emit("removeImage",F),class:"remove-attachment-btn",icon:"mdi-close",size:"small",color:"error",variant:"text"},null,8,["onClick"])]))),128)),a.stagedAudioUrl?(b(),M("div",ft,[i(se,{color:"deep-purple-lighten-4",class:"audio-chip"},{default:u(()=>[i(H,{start:"",icon:"mdi-microphone",size:"small"}),V(" "+Z(oe(c)("voice.recording")),1)]),_:1}),i(Y,{onClick:R[4]||(R[4]=U=>a.$emit("removeAudio")),class:"remove-attachment-btn",icon:"mdi-close",size:"small",color:"error",variant:"text"})])):W("",!0),(b(!0),M(ue,null,de(a.stagedFiles,(U,F)=>(b(),M("div",{key:"file-"+F,class:"file-preview"},[i(se,{color:"blue-grey-lighten-4",class:"file-chip"},{default:u(()=>[i(H,{start:"",icon:"mdi-file-document-outline",size:"small"}),G("span",mt,Z(U.original_name),1)]),_:2},1024),i(Y,{onClick:te=>a.$emit("removeFile",F),class:"remove-attachment-btn",icon:"mdi-close",size:"small",color:"error",variant:"text"},null,8,["onClick"])]))),128))])):W("",!0)]))}});const Ct=ye(vt,[["__scopeId","data-v-4fe13fca"]]);function wt(S,y,r,d){const c=v([]),C=v(!1),h=v(!1),k=v(!1),z=v(0),w=v(!0),L=new Map,I=localStorage.getItem("enableStreaming");I!==null&&(w.value=JSON.parse(I));function A(){w.value=!w.value,localStorage.setItem("enableStreaming",JSON.stringify(w.value))}async function N(e){if(L.has(e))return L.get(e);try{const n=await q.get(`/api/chat/get_attachment?attachment_id=${e}`,{responseType:"blob"}),o=URL.createObjectURL(n.data);return L.set(e,o),o}catch(n){return console.error("Failed to get attachment:",e,n),""}}async function s(e){const n=e.message;if(typeof n=="string"){const o=[];let E=n;if(E.startsWith("[IMAGE]")){const J=E.replace("[IMAGE]",""),P=await y(J);o.push({type:"image",embedded_url:P})}else if(E.startsWith("[RECORD]")){const J=E.replace("[RECORD]",""),P=await y(J);o.push({type:"record",embedded_url:P})}else E&&o.push({type:"plain",text:E});e.message=o;return}if(Array.isArray(n))for(const o of n)o.type==="image"&&o.attachment_id?o.embedded_url=await N(o.attachment_id):o.type==="record"&&o.attachment_id?o.embedded_url=await N(o.attachment_id):o.type==="file"&&o.attachment_id&&(o.embedded_file={attachment_id:o.attachment_id,filename:o.filename||"file"});e.agent_stats&&(e.agentStats=e.agent_stats,delete e.agent_stats)}async function m(e){if(e)try{const n=await q.get("/api/chat/get_session?session_id="+e);h.value=n.data.data.is_running||!1;let o=n.data.data.history;h.value&&(k.value||(Re().info("该会话正在运行中。",{timeout:5e3}),k.value=!0),setTimeout(()=>{m(S.value)},3e3));for(let E=0;E<o.length;E++){let J=o[E].content;await s(J)}c.value=o}catch(n){console.error(n)}}async function t(e,n,o,E,J,P=null){var U,F,te;const ee=[];P&&ee.push({type:"reply",message_id:P.messageId,reply_content:P.messageContent}),e&&ee.push({type:"plain",text:e});for(const K of n){const B=K.type==="image"?"image":K.type==="record"?"record":"file",l=await N(K.attachment_id);ee.push({type:B,attachment_id:K.attachment_id,filename:K.original_name,embedded_url:B!=="file"?l:void 0,embedded_file:B==="file"?{attachment_id:K.attachment_id,filename:K.original_name}:void 0})}o&&ee.push({type:"record",embedded_url:o});const a={type:"user",message:ee};c.value.push({content:a});const R=re({type:"bot",message:[],reasoning:"",isLoading:!0});c.value.push({content:R});try{z.value++,z.value===1&&(h.value=!0);const K=n.map(O=>O.attachment_id);let B;if(K.length>0||P){const O=[];P&&O.push({type:"reply",message_id:P.messageId}),e&&O.push({type:"plain",text:e});for(const ne of n){const he=ne.type==="image"?"image":ne.type==="record"?"record":"file";O.push({type:he,attachment_id:ne.attachment_id})}B=O}else B=e;const l=await fetch("/api/chat/send",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+localStorage.getItem("token")},body:JSON.stringify({message:B,session_id:S.value,selected_provider:E,selected_model:J,enable_streaming:w.value})});if(!l.ok)throw new Error(`HTTP error! status: ${l.status}`);const g=l.body.getReader(),_=new TextDecoder;let x=!1,p=null;for(C.value=!0;;)try{const{done:O,value:ne}=await g.read();if(O){console.log("SSE stream completed"),S.value&&await m(S.value);break}const _e=_.decode(ne,{stream:!0}).split(`

`);for(let pe=0;pe<_e.length;pe++){let fe=_e[pe].trim();if(!fe)continue;let f;try{f=JSON.parse(fe.replace("data: ",""))}catch(T){console.warn("JSON解析失败:",fe,T);continue}if(!f||typeof f!="object"||!f.hasOwnProperty("type")){console.warn("无效的数据对象:",f);continue}const me=c.value[c.value.length-1];if((U=me==null?void 0:me.content)!=null&&U.isLoading&&c.value.pop(),f.type==="error"){console.error("Error received:",f.data);continue}if(f.type==="image"){let T=f.data.replace("[IMAGE]",""),j={type:"bot",message:[{type:"image",embedded_url:await y(T)}]};c.value.push({content:j})}else if(f.type==="record"){let T=f.data.replace("[RECORD]",""),j={type:"bot",message:[{type:"record",embedded_url:await y(T)}]};c.value.push({content:j})}else if(f.type==="file"){let T=f.data.replace("[FILE]",""),[$,j]=T.includes("|")?T.split("|",2):[T,T],ie={type:"bot",message:[{type:"file",embedded_file:{url:await y($),filename:j}}]};c.value.push({content:ie})}else if(f.type==="plain"){const T=f.chain_type||"normal";if(T==="tool_call"){const $=JSON.parse(f.data),j={id:$.id,name:$.name,args:$.args,ts:$.ts};if(!x)p=re({type:"bot",message:[{type:"tool_call",tool_calls:[j]}]}),c.value.push({content:p}),x=!0;else{const Q=p.message[p.message.length-1];(Q==null?void 0:Q.type)==="tool_call"?Q.tool_calls.findIndex(Ue=>Ue.id===j.id)===-1&&Q.tool_calls.push(j):p.message.push({type:"tool_call",tool_calls:[j]})}}else if(T==="tool_call_result"){const $=JSON.parse(f.data);if(p){for(const j of p.message)if(j.type==="tool_call"&&j.tool_calls){const Q=j.tool_calls.find(ie=>ie.id===$.id);if(Q){Q.result=$.result,Q.finished_ts=$.ts;break}}}}else if(T==="reasoning")x?p.reasoning=(p.reasoning||"")+f.data:(p=re({type:"bot",message:[],reasoning:f.data}),c.value.push({content:p}),x=!0);else if(!x)p=re({type:"bot",message:[{type:"plain",text:f.data}]}),c.value.push({content:p}),x=!0;else{const $=p.message[p.message.length-1];($==null?void 0:$.type)==="plain"?$.text=($.text||"")+f.data:p.message.push({type:"plain",text:f.data})}}else if(f.type==="update_title")r(f.session_id,f.data);else if(f.type==="message_saved"){const T=c.value[c.value.length-1];T&&((F=T.content)==null?void 0:F.type)==="bot"&&(T.id=f.data.id,T.created_at=f.data.created_at)}else f.type==="agent_stats"&&p&&(p.agentStats=f.data);(f.type==="break"&&f.streaming||!f.streaming)&&(x=!1,f.streaming||(C.value=!1))}}catch(O){console.error("SSE读取错误:",O);break}d()}catch(K){console.error("发送消息失败:",K);const B=c.value[c.value.length-1];(te=B==null?void 0:B.content)!=null&&te.isLoading&&c.value.pop()}finally{C.value=!1,z.value--,z.value===0&&(h.value=!1)}}return{messages:c,isStreaming:C,isConvRunning:h,enableStreaming:w,getSessionMessages:m,sendMessage:t,toggleStreaming:A,getAttachment:N}}function kt(){const S=v(""),y=v([]),r=v({});async function d(s){if(r.value[s])return r.value[s];try{const m=await q.get("/api/chat/get_file",{params:{filename:s},responseType:"blob"}),t=URL.createObjectURL(m.data);return r.value[s]=t,t}catch(m){return console.error("Error fetching media file:",m),""}}async function c(s){const m=new FormData;m.append("file",s);try{const t=await q.post("/api/chat/post_file",m,{headers:{"Content-Type":"multipart/form-data"}}),{attachment_id:e,filename:n,type:o}=t.data.data;y.value.push({attachment_id:e,filename:n,original_name:s.name,url:URL.createObjectURL(s),type:o})}catch(t){console.error("Error uploading image:",t)}}async function C(s){const m=new FormData;m.append("file",s);try{const t=await q.post("/api/chat/post_file",m,{headers:{"Content-Type":"multipart/form-data"}}),{attachment_id:e,filename:n,type:o}=t.data.data;y.value.push({attachment_id:e,filename:n,original_name:s.name,url:URL.createObjectURL(s),type:o})}catch(t){console.error("Error uploading file:",t)}}async function h(s){var t;const m=(t=s.clipboardData)==null?void 0:t.items;if(m){for(let e=0;e<m.length;e++)if(m[e].type.indexOf("image")!==-1){const n=m[e].getAsFile();n&&await c(n)}}}function k(s){let m=0;for(let t=0;t<y.value.length;t++)if(y.value[t].type==="image"){if(m===s){const e=y.value[t];e.url.startsWith("blob:")&&URL.revokeObjectURL(e.url),y.value.splice(t,1);return}m++}}function z(){S.value=""}function w(s){let m=0;for(let t=0;t<y.value.length;t++)if(y.value[t].type!=="image"){if(m===s){const e=y.value[t];e.url.startsWith("blob:")&&URL.revokeObjectURL(e.url),y.value.splice(t,1);return}m++}}function L(){S.value="",y.value.forEach(s=>{s.url.startsWith("blob:")&&URL.revokeObjectURL(s.url)}),y.value=[]}function I(){Object.values(r.value).forEach(s=>{s.startsWith("blob:")&&URL.revokeObjectURL(s)}),r.value={}}const A=D(()=>y.value.filter(s=>s.type==="image").map(s=>s.url)),N=D(()=>y.value.filter(s=>s.type!=="image"));return{stagedImagesUrl:A,stagedAudioUrl:S,stagedFiles:y,stagedNonImageFiles:N,getMediaFile:d,processAndUploadImage:c,processAndUploadFile:C,handlePaste:h,removeImage:k,removeAudio:z,removeFile:w,clearStaged:L,cleanupMediaCache:I}}function St(){const S=v(!1),y=v([]),r=v(null);async function d(C){try{const h=await navigator.mediaDevices.getUserMedia({audio:!0});r.value=new MediaRecorder(h),r.value.ondataavailable=k=>{y.value.push(k.data)},r.value.start(),S.value=!0,C&&C("录音中...")}catch(h){console.error("Failed to start recording:",h)}}async function c(C){return new Promise((h,k)=>{if(!r.value){k("No media recorder");return}S.value=!1,C&&C("聊天输入框"),r.value.stop(),r.value.onstop=async()=>{var L;const z=new Blob(y.value,{type:"audio/wav"});y.value=[],(L=r.value)==null||L.stream.getTracks().forEach(I=>I.stop());const w=new FormData;w.append("file",z);try{const A=(await q.post("/api/chat/post_file",w,{headers:{"Content-Type":"multipart/form-data"}})).data.data.filename;console.log("Audio uploaded:",A),h(A)}catch(I){console.error("Error uploading audio:",I),k(I)}}})}return{isRecording:S,startRecording:d,stopRecording:c}}export{Ct as C,St as a,wt as b,kt as u};
