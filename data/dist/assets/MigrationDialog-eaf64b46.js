import{u as H,v as C,c as A,x as Y,K as N,o as i,g as f,b as a,w as t,y as F,z as q,e as u,t as l,f as m,C as K,A as w,l as D,G as R,E as T,B,F as P,h as U,a as G,a$ as Q,a3 as X,ah as Z,ai as ee,p as ae,H as te,I as oe,J as se,R as re,S as ie}from"./index-61371d60.js";import{C as le}from"./ConsoleDisplayer-69ceb810.js";import{W as ne}from"./WaitingForRestart-d6ba996f.js";import{_ as ce}from"./_plugin-vue_export-helper-c27b6911.js";const Ne=[{title:"core.navigation.platforms",icon:"mdi-robot",to:"/"},{title:"core.navigation.providers",icon:"mdi-creation",to:"/providers"},{title:"core.navigation.config",icon:"mdi-cog",to:"/config"},{title:"core.navigation.extension",icon:"mdi-puzzle",to:"/extension"},{title:"core.navigation.knowledgeBase",icon:"mdi-book-open-variant",to:"/knowledge-base"},{title:"core.navigation.groups.more",icon:"mdi-dots-horizontal",children:[{title:"core.navigation.persona",icon:"mdi-heart",to:"/persona"},{title:"core.navigation.conversation",icon:"mdi-database",to:"/conversation"},{title:"core.navigation.sessionManagement",icon:"mdi-pencil-ruler",to:"/session-management"},{title:"core.navigation.dashboard",icon:"mdi-view-dashboard",to:"/dashboard/default"},{title:"core.navigation.console",icon:"mdi-console",to:"/console"}]}],O="astrbot_sidebar_customization";function de(){try{const r=localStorage.getItem(O);return r?JSON.parse(r):null}catch(r){return console.error("Error reading sidebar customization:",r),null}}function Re(r){try{localStorage.setItem(O,JSON.stringify(r))}catch(b){console.error("Error saving sidebar customization:",b)}}function Ge(){try{localStorage.removeItem(O)}catch(r){console.error("Error clearing sidebar customization:",r)}}function ue(r,b,o={}){const{cloneItems:v=!1,assembleMoreGroup:M=!1}=o,c=new Map,g=[],k=[];r.forEach(s=>{s.children?s.children.forEach(d=>{c.set(d.title,v?{...d}:d),k.push(d.title)}):(c.set(s.title,v?{...s}:s),g.push(s.title))});const _=!!b,S=_?b.mainItems||[]:g,V=_?b.moreItems||[]:k,E=_?new Set([...S,...V]):new Set(g.concat(k)),h=S.map(s=>c.get(s)).filter(Boolean);_&&g.forEach(s=>{if(!E.has(s)){const d=c.get(s);d&&h.push(d)}});const x=V.map(s=>c.get(s)).filter(Boolean);_&&k.forEach(s=>{if(!E.has(s)){const d=c.get(s);d&&x.push(d)}});let z;if(M){const s=v?x.map(d=>({...d})):[...x];s.length>0?z=[...h,{title:"core.navigation.groups.more",icon:"mdi-dots-horizontal",children:s}]:z=[...h]}return{mainItems:h,moreItems:x,merged:z}}function Oe(r){const b=de(),{merged:o}=ue(r,b,{cloneItems:!0,assembleMoreGroup:!0});return o||r}const me=r=>(re("data-v-0a09ebf0"),r=r(),ie(),r),fe={class:"mb-4"},ge={key:0,class:"text-center py-8"},pe={class:"mb-4"},ve={class:"mb-4"},_e={key:1,class:"migration-in-progress"},he={class:"text-center py-4"},ye={class:"mb-4"},be={class:"mb-4"},ke={class:"console-container"},Ve={key:2,class:"text-center py-8"},xe={key:3,class:"text-center py-4"},Ce={key:4},we={key:0,class:"text-center py-4"},Se={key:1},Ee=me(()=>w("small",null,"请选择该平台类型下您主要使用的平台适配器。",-1)),Ie={__name:"MigrationDialog",setup(r,{expose:b}){const{t:o}=H(),v=C(!1),M=C(!1),c=C(""),g=C(!1),k=C(!1),_=C(null),S=C([]),V=C({}),E=C(null);let h=null;const x=A(()=>{const e={};return S.value.forEach(n=>{const p=n.platform_type||n.type;e[p]||(e[p]={type:p,platforms:[]}),e[p].platforms.push(n)}),Object.values(e)}),z=A(()=>x.value.every(e=>V.value[e.type]));Y(v,e=>{e?s():(S.value=[],V.value={},c.value="",g.value=!1,k.value=!1,_.value=null)});const s=async()=>{M.value=!0,c.value="";try{const e=await N.get("/api/config/platform/list");e.data.status==="ok"?(S.value=e.data.data.platforms||[],x.value.forEach(n=>{n.platforms.length>0&&(V.value[n.type]=n.platforms[0].id)})):c.value=e.data.message||o("features.migration.dialog.loadError")}catch(e){console.error("Failed to load platforms:",e),c.value=o("features.migration.dialog.loadError")}finally{M.value=!1}},d=async()=>{g.value=!0;try{const e={};Object.entries(V.value).forEach(([p,y])=>{S.value.find($=>$.id===y)&&(e[p]={platform_id:y,platform_type:p})}),console.log("Migration platform_id_map:",e);const n=await N.post("/api/update/migration",{platform_id_map:e});if(n.data.status==="ok")k.value=!0,_.value={success:!0,message:n.data.message||o("features.migration.dialog.success")};else throw new Error(n.data.message||o("features.migration.dialog.migrationError"))}catch(e){console.error("Migration failed:",e),c.value=e.message||o("features.migration.dialog.migrationError")}finally{g.value=!1}},J=()=>{v.value=!1,h&&h({success:!1,cancelled:!0})},L=()=>{v.value=!1,h&&h(_.value)},j=e=>`${e.name||e.id||"Unknown"}`,W=()=>{N.post("/api/stat/restart-core").then(()=>{E.value&&E.value.check()})};return b({open:()=>(v.value=!0,new Promise(e=>{h=e}))}),(e,n)=>(i(),f(P,null,[a(se,{modelValue:v.value,"onUpdate:modelValue":n[0]||(n[0]=p=>v.value=p),persistent:"","max-width":"600","max-height":"80vh",scrollable:""},{default:t(()=>[a(F,null,{default:t(()=>[a(q,null,{default:t(()=>[u(l(m(o)("features.migration.dialog.title")),1)]),_:1}),a(K,{class:"pa-6"},{default:t(()=>{var p;return[w("p",fe,l(m(o)("features.migration.dialog.warning")),1),k.value?(i(),f("div",ge,[a(D,{size:"64",color:"success",class:"mb-4"},{default:t(()=>[u("mdi-check-circle")]),_:1}),w("h3",pe,l(m(o)("features.migration.dialog.completed")),1),w("p",ve,l(((p=_.value)==null?void 0:p.message)||m(o)("features.migration.dialog.success")),1),a(R,{type:"info",variant:"tonal",class:"mb-4"},{prepend:t(()=>[a(D,null,{default:t(()=>[u("mdi-information")]),_:1})]),default:t(()=>[u(" "+l(m(o)("features.migration.dialog.restartRecommended")),1)]),_:1})])):g.value?(i(),f("div",_e,[w("div",he,[a(T,{indeterminate:"",color:"primary",class:"mb-4"}),w("h3",ye,l(m(o)("features.migration.dialog.migrating")),1),w("p",be,l(m(o)("features.migration.dialog.migratingSubtitle")),1)]),w("div",ke,[a(le,{ref:"consoleDisplayer",showLevelBtns:!1,style:{height:"300px"}},null,512)])])):M.value?(i(),f("div",Ve,[a(T,{indeterminate:"",color:"primary",class:"mb-4"}),w("p",null,l(m(o)("features.migration.dialog.loading")),1)])):c.value?(i(),f("div",xe,[a(R,{type:"error",variant:"tonal",class:"mb-4"},{prepend:t(()=>[a(D,null,{default:t(()=>[u("mdi-alert")]),_:1})]),default:t(()=>[u(" "+l(c.value),1)]),_:1}),a(B,{color:"primary",onClick:s},{default:t(()=>[u(l(m(o)("features.migration.dialog.retry")),1)]),_:1})])):(i(),f("div",Ce,[x.value.length===0?(i(),f("div",we,[a(R,{type:"info",variant:"tonal"},{prepend:t(()=>[a(D,null,{default:t(()=>[u("mdi-information")]),_:1})]),default:t(()=>[u(" "+l(m(o)("features.migration.dialog.noPlatforms")),1)]),_:1})])):(i(),f("div",Se,[(i(!0),f(P,null,U(x.value,y=>(i(),f("div",{key:y.type,class:"mb-6"},[y.platforms.length>1?(i(),G(F,{key:0,variant:"outlined"},{default:t(()=>[a(Q,{class:"py-2"},{default:t(()=>[u(l(y.type),1)]),_:2},1024),a(X),a(K,{style:{padding:"16px"}},{default:t(()=>[Ee,(i(),G(Z,{modelValue:V.value[y.type],"onUpdate:modelValue":I=>V.value[y.type]=I,key:y.type,"hide-details":""},{default:t(()=>[(i(!0),f(P,null,U(y.platforms,I=>(i(),G(ee,{key:I.id,value:I.id,label:j(I),color:"primary",class:"mb-1"},null,8,["value","label"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"]))]),_:2},1024)]),_:2},1024)):ae("",!0)]))),128))]))]))]}),_:1}),a(te,{class:"px-6 py-4"},{default:t(()=>[a(oe),k.value?(i(),f(P,{key:0},[a(B,{color:"grey",variant:"text",onClick:L},{default:t(()=>[u(l(m(o)("core.common.close")),1)]),_:1}),a(B,{color:"primary",variant:"elevated",onClick:W},{default:t(()=>[u(l(m(o)("features.migration.dialog.restartNow")),1)]),_:1})],64)):(i(),f(P,{key:1},[a(B,{color:"grey",variant:"text",onClick:J,disabled:g.value},{default:t(()=>[u(l(m(o)("core.common.cancel")),1)]),_:1},8,["disabled"]),a(B,{color:"primary",variant:"elevated",onClick:d,disabled:!z.value||g.value,loading:g.value},{default:t(()=>[u(l(m(o)("features.migration.dialog.startMigration")),1)]),_:1},8,["disabled","loading"])],64))]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(ne,{ref_key:"wfr",ref:E},null,512)],64))}},Ae=ce(Ie,[["__scopeId","data-v-0a09ebf0"]]);export{Ae as M,Oe as a,Re as b,Ge as c,de as g,ue as r,Ne as s};
