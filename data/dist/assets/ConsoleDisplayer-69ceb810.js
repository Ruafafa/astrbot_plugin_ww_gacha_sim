import{u as Pe}from"./common-619402c2.js";import{aS as Ge,o as ee,g as ce,b as Xe,w as Le,F as qe,h as ke,a as We,e as $e,t as ze,k as Ke,b2 as Qe,p as Je,K as Ze,R as Ye,S as et,A as tt}from"./index-61371d60.js";import{_ as rt}from"./_plugin-vue_export-helper-c27b6911.js";var fe={exports:{}};/** @license
 * eventsource.js
 * Available under MIT License (MIT)
 * https://github.com/Yaffle/EventSource/
 */(function(c,u){(function(s){var y=s.setTimeout,S=s.clearTimeout,b=s.XMLHttpRequest,ue=s.XDomainRequest,he=s.ActiveXObject,K=s.EventSource,H=s.document,Re=s.Promise,Q=s.fetch,pe=s.Response,J=s.TextDecoder,ve=s.TextEncoder,te=s.AbortController;if(typeof window<"u"&&typeof H<"u"&&!("readyState"in H)&&H.body==null&&(H.readyState="loading",window.addEventListener("load",function(e){H.readyState="complete"},!1)),b==null&&he!=null&&(b=function(){return new he("Microsoft.XMLHTTP")}),Object.create==null&&(Object.create=function(e){function r(){}return r.prototype=e,new r}),Date.now||(Date.now=function(){return new Date().getTime()}),te==null){var xe=Q;Q=function(e,r){var n=r.signal;return xe(e,{headers:r.headers,credentials:r.credentials,cache:r.cache}).then(function(t){var a=t.body.getReader();return n._reader=a,n._aborted&&n._reader.cancel(),{status:t.status,statusText:t.statusText,headers:t.headers,body:{getReader:function(){return a}}}})},te=function(){this.signal={_reader:null,_aborted:!1},this.abort=function(){this.signal._reader!=null&&this.signal._reader.cancel(),this.signal._aborted=!0}}}function ye(){this.bitsNeeded=0,this.codePoint=0}ye.prototype.decode=function(e){function r(f,h,i){if(i===1)return f>=128>>h&&f<<h<=2047;if(i===2)return f>=2048>>h&&f<<h<=55295||f>=57344>>h&&f<<h<=65535;if(i===3)return f>=65536>>h&&f<<h<=1114111;throw new Error}function n(f,h){if(f===6*1)return h>>6>15?3:h>31?2:1;if(f===6*2)return h>15?3:2;if(f===6*3)return 3;throw new Error}for(var t=65533,a="",o=this.bitsNeeded,l=this.codePoint,p=0;p<e.length;p+=1){var d=e[p];o!==0&&(d<128||d>191||!r(l<<6|d&63,o-6,n(o,l)))&&(o=0,l=t,a+=String.fromCharCode(l)),o===0?(d>=0&&d<=127?(o=0,l=d):d>=192&&d<=223?(o=6*1,l=d&31):d>=224&&d<=239?(o=6*2,l=d&15):d>=240&&d<=247?(o=6*3,l=d&7):(o=0,l=t),o!==0&&!r(l,o,n(o,l))&&(o=0,l=t)):(o-=6,l=l<<6|d&63),o===0&&(l<=65535?a+=String.fromCharCode(l):(a+=String.fromCharCode(55296+(l-65535-1>>10)),a+=String.fromCharCode(56320+(l-65535-1&1023))))}return this.bitsNeeded=o,this.codePoint=l,a};var De=function(){try{return new J().decode(new ve().encode("test"),{stream:!0})==="test"}catch(e){console.debug("TextDecoder does not support streaming option. Using polyfill instead: "+e)}return!1};(J==null||ve==null||!De())&&(J=ye);var L=function(){};function j(e){this.withCredentials=!1,this.readyState=0,this.status=0,this.statusText="",this.responseText="",this.onprogress=L,this.onload=L,this.onerror=L,this.onreadystatechange=L,this._contentType="",this._xhr=e,this._sendTimeout=0,this._abort=L}j.prototype.open=function(e,r){this._abort(!0);var n=this,t=this._xhr,a=1,o=0;this._abort=function(i){n._sendTimeout!==0&&(S(n._sendTimeout),n._sendTimeout=0),(a===1||a===2||a===3)&&(a=4,t.onload=L,t.onerror=L,t.onabort=L,t.onprogress=L,t.onreadystatechange=L,t.abort(),o!==0&&(S(o),o=0),i||(n.readyState=4,n.onabort(null),n.onreadystatechange())),a=0};var l=function(){if(a===1){var i=0,v="",D=void 0;if("contentType"in t)i=200,v="OK",D=t.contentType;else try{i=t.status,v=t.statusText,D=t.getResponseHeader("Content-Type")}catch{i=0,v="",D=void 0}i!==0&&(a=2,n.readyState=2,n.status=i,n.statusText=v,n._contentType=D,n.onreadystatechange())}},p=function(){if(l(),a===2||a===3){a=3;var i="";try{i=t.responseText}catch{}n.readyState=3,n.responseText=i,n.onprogress()}},d=function(i,v){if((v==null||v.preventDefault==null)&&(v={preventDefault:L}),p(),a===1||a===2||a===3){if(a=4,o!==0&&(S(o),o=0),n.readyState=4,i==="load")n.onload(v);else if(i==="error")n.onerror(v);else if(i==="abort")n.onabort(v);else throw new TypeError;n.onreadystatechange()}},f=function(i){t!=null&&(t.readyState===4?(!("onload"in t)||!("onerror"in t)||!("onabort"in t))&&d(t.responseText===""?"error":"load",i):t.readyState===3?"onprogress"in t||p():t.readyState===2&&l())},h=function(){o=y(function(){h()},500),t.readyState===3&&p()};"onload"in t&&(t.onload=function(i){d("load",i)}),"onerror"in t&&(t.onerror=function(i){d("error",i)}),"onabort"in t&&(t.onabort=function(i){d("abort",i)}),"onprogress"in t&&(t.onprogress=p),"onreadystatechange"in t&&(t.onreadystatechange=function(i){f(i)}),("contentType"in t||!("ontimeout"in b.prototype))&&(r+=(r.indexOf("?")===-1?"?":"&")+"padding=true"),t.open(e,r,!0),"readyState"in t&&(o=y(function(){h()},0))},j.prototype.abort=function(){this._abort(!1)},j.prototype.getResponseHeader=function(e){return this._contentType},j.prototype.setRequestHeader=function(e,r){var n=this._xhr;"setRequestHeader"in n&&n.setRequestHeader(e,r)},j.prototype.getAllResponseHeaders=function(){return this._xhr.getAllResponseHeaders!=null&&this._xhr.getAllResponseHeaders()||""},j.prototype.send=function(){if((!("ontimeout"in b.prototype)||!("sendAsBinary"in b.prototype)&&!("mozAnon"in b.prototype))&&H!=null&&H.readyState!=null&&H.readyState!=="complete"){var e=this;e._sendTimeout=y(function(){e._sendTimeout=0,e.send()},4);return}var r=this._xhr;"withCredentials"in r&&(r.withCredentials=this.withCredentials);try{r.send(void 0)}catch(n){throw n}};function me(e){return e.replace(/[A-Z]/g,function(r){return String.fromCharCode(r.charCodeAt(0)+32)})}function ge(e){for(var r=Object.create(null),n=e.split(`\r
`),t=0;t<n.length;t+=1){var a=n[t],o=a.split(": "),l=o.shift(),p=o.join(": ");r[me(l)]=p}this._map=r}ge.prototype.get=function(e){return this._map[me(e)]},b!=null&&b.HEADERS_RECEIVED==null&&(b.HEADERS_RECEIVED=2);function Ee(){}Ee.prototype.open=function(e,r,n,t,a,o,l){e.open("GET",a);var p=0;e.onprogress=function(){var f=e.responseText,h=f.slice(p);p+=h.length,n(h)},e.onerror=function(f){f.preventDefault(),t(new Error("NetworkError"))},e.onload=function(){t(null)},e.onabort=function(){t(null)},e.onreadystatechange=function(){if(e.readyState===b.HEADERS_RECEIVED){var f=e.status,h=e.statusText,i=e.getResponseHeader("Content-Type"),v=e.getAllResponseHeaders();r(f,h,i,new ge(v))}},e.withCredentials=o;for(var d in l)Object.prototype.hasOwnProperty.call(l,d)&&e.setRequestHeader(d,l[d]);return e.send(),e};function Se(e){this._headers=e}Se.prototype.get=function(e){return this._headers.get(e)};function we(){}we.prototype.open=function(e,r,n,t,a,o,l){var p=null,d=new te,f=d.signal,h=new J;return Q(a,{headers:l,credentials:o?"include":"same-origin",signal:f,cache:"no-store"}).then(function(i){return p=i.body.getReader(),r(i.status,i.statusText,i.headers.get("Content-Type"),new Se(i.headers)),new Re(function(v,D){var $=function(){p.read().then(function(_){if(_.done)v(void 0);else{var w=h.decode(_.value,{stream:!0});n(w),$()}}).catch(function(_){D(_)})};$()})}).catch(function(i){if(i.name!=="AbortError")return i}).then(function(i){t(i)}),{abort:function(){p!=null&&p.cancel(),d.abort()}}};function k(){this._listeners=Object.create(null)}function Ce(e){y(function(){throw e},0)}k.prototype.dispatchEvent=function(e){e.target=this;var r=this._listeners[e.type];if(r!=null)for(var n=r.length,t=0;t<n;t+=1){var a=r[t];try{typeof a.handleEvent=="function"?a.handleEvent(e):a.call(this,e)}catch(o){Ce(o)}}},k.prototype.addEventListener=function(e,r){e=String(e);var n=this._listeners,t=n[e];t==null&&(t=[],n[e]=t);for(var a=!1,o=0;o<t.length;o+=1)t[o]===r&&(a=!0);a||t.push(r)},k.prototype.removeEventListener=function(e,r){e=String(e);var n=this._listeners,t=n[e];if(t!=null){for(var a=[],o=0;o<t.length;o+=1)t[o]!==r&&a.push(t[o]);a.length===0?delete n[e]:n[e]=a}};function V(e){this.type=e,this.target=void 0}function Te(e,r){V.call(this,e),this.data=r.data,this.lastEventId=r.lastEventId}Te.prototype=Object.create(V.prototype);function re(e,r){V.call(this,e),this.status=r.status,this.statusText=r.statusText,this.headers=r.headers}re.prototype=Object.create(V.prototype);function be(e,r){V.call(this,e),this.error=r.error}be.prototype=Object.create(V.prototype);var ne=-1,M=0,P=1,W=2,oe=-1,B=0,ae=1,_e=2,Ie=3,Ne=/^text\/event\-stream(;.*)?$/i,Oe=1e3,He=18e6,ie=function(e,r){var n=e==null?r:parseInt(e,10);return n!==n&&(n=r),se(n)},se=function(e){return Math.min(Math.max(e,Oe),He)},G=function(e,r,n){try{typeof r=="function"&&r.call(e,n)}catch(t){Ce(t)}};function R(e,r){k.call(this),r=r||{},this.onopen=void 0,this.onmessage=void 0,this.onerror=void 0,this.url=void 0,this.readyState=void 0,this.withCredentials=void 0,this.headers=void 0,this._close=void 0,je(this,e,r)}function Me(){return b!=null&&"withCredentials"in b.prototype||ue==null?new b:new ue}var Be=Q!=null&&pe!=null&&"body"in pe.prototype;function je(e,r,n){r=String(r);var t=!!n.withCredentials,a=n.lastEventIdQueryParameterName||"lastEventId",o=se(1e3),l=ie(n.heartbeatTimeout,45e3),p="",d=o,f=!1,h=0,i=n.headers||{},v=n.Transport,D=Be&&v==null?void 0:new j(v!=null?new v:Me()),$=v!=null&&typeof v!="string"?new v:D==null?new we:new Ee,_=void 0,w=0,x=ne,X="",Z="",I="",Y="",C=B,le=0,U=0,Ue=function(g,m,F,A){if(x===M)if(g===200&&F!=null&&Ne.test(F)){x=P,f=Date.now(),d=o,e.readyState=P;var T=new re("open",{status:g,statusText:m,headers:A});e.dispatchEvent(T),G(e,e.onopen,T)}else{var E="";g!==200?(m&&(m=m.replace(/\s+/g," ")),E="EventSource's response has a status "+g+" "+m+" that is not 200. Aborting the connection."):E="EventSource's response has a Content-Type specifying an unsupported type: "+(F==null?"-":F.replace(/\s+/g," "))+". Aborting the connection.",de();var T=new re("error",{status:g,statusText:m,headers:A});e.dispatchEvent(T),G(e,e.onerror,T),console.error(E)}},Ve=function(g){if(x===P){for(var m=-1,F=0;F<g.length;F+=1){var A=g.charCodeAt(F);(A===`
`.charCodeAt(0)||A==="\r".charCodeAt(0))&&(m=F)}var T=(m!==-1?Y:"")+g.slice(0,m+1);Y=(m===-1?Y:"")+g.slice(m+1),g!==""&&(f=Date.now(),h+=g.length);for(var E=0;E<T.length;E+=1){var A=T.charCodeAt(E);if(C===oe&&A===`
`.charCodeAt(0))C=B;else if(C===oe&&(C=B),A==="\r".charCodeAt(0)||A===`
`.charCodeAt(0)){if(C!==B){C===ae&&(U=E+1);var N=T.slice(le,U-1),O=T.slice(U+(U<E&&T.charCodeAt(U)===" ".charCodeAt(0)?1:0),E);N==="data"?(X+=`
`,X+=O):N==="id"?Z=O:N==="event"?I=O:N==="retry"?(o=ie(O,o),d=o):N==="heartbeatTimeout"&&(l=ie(O,l),w!==0&&(S(w),w=y(function(){z()},l)))}if(C===B){if(X!==""){p=Z,I===""&&(I="message");var q=new Te(I,{data:X.slice(1),lastEventId:Z});if(e.dispatchEvent(q),I==="open"?G(e,e.onopen,q):I==="message"?G(e,e.onmessage,q):I==="error"&&G(e,e.onerror,q),x===W)return}X="",I=""}C=A==="\r".charCodeAt(0)?oe:B}else C===B&&(le=E,C=ae),C===ae?A===":".charCodeAt(0)&&(U=E+1,C=_e):C===_e&&(C=Ie)}}},Ae=function(g){if(x===P||x===M){x=ne,w!==0&&(S(w),w=0),w=y(function(){z()},d),d=se(Math.min(o*16,d*2)),e.readyState=M;var m=new be("error",{error:g});e.dispatchEvent(m),G(e,e.onerror,m),g!=null&&console.error(g)}},de=function(){x=W,_!=null&&(_.abort(),_=void 0),w!==0&&(S(w),w=0),e.readyState=W},z=function(){if(w=0,x!==ne){if(!f&&_!=null)Ae(new Error("No activity within "+l+" milliseconds. "+(x===M?"No response received.":h+" chars received.")+" Reconnecting.")),_!=null&&(_.abort(),_=void 0);else{var g=Math.max((f||Date.now())+l-Date.now(),1);f=!1,w=y(function(){z()},g)}return}f=!1,h=0,w=y(function(){z()},l),x=M,X="",I="",Z=p,Y="",le=0,U=0,C=B;var m=r;if(r.slice(0,5)!=="data:"&&r.slice(0,5)!=="blob:"&&p!==""){var F=r.indexOf("?");m=F===-1?r:r.slice(0,F+1)+r.slice(F+1).replace(/(?:^|&)([^=&]*)(?:=[^&]*)?/g,function(O,q){return q===a?"":O}),m+=(r.indexOf("?")===-1?"?":"&")+a+"="+encodeURIComponent(p)}var A=e.withCredentials,T={};T.Accept="text/event-stream";var E=e.headers;if(E!=null)for(var N in E)Object.prototype.hasOwnProperty.call(E,N)&&(T[N]=E[N]);try{_=$.open(D,Ue,Ve,Ae,m,A,T)}catch(O){throw de(),O}};e.url=r,e.readyState=M,e.withCredentials=t,e.headers=i,e._close=de,z()}R.prototype=Object.create(k.prototype),R.prototype.CONNECTING=M,R.prototype.OPEN=P,R.prototype.CLOSED=W,R.prototype.close=function(){this._close()},R.CONNECTING=M,R.OPEN=P,R.CLOSED=W,R.prototype.withCredentials=void 0;var Fe=K;b!=null&&(K==null||!("withCredentials"in K.prototype))&&(Fe=R),function(e){{var r=e(u);r!==void 0&&(c.exports=r)}}(function(e){e.EventSourcePolyfill=R,e.NativeEventSource=K,e.EventSource=Fe})})(typeof globalThis>"u"?typeof window<"u"?window:typeof self<"u"?self:Ge:globalThis)})(fe,fe.exports);var nt=fe.exports;const ot=c=>(Ye("data-v-6bf2d586"),c=c(),et(),c),at={key:0,class:"filter-controls mb-2"},it=ot(()=>tt("div",{id:"term",style:{"background-color":"#1e1e1e",padding:"16px","border-radius":"8px","overflow-y":"auto",height:"100%"}},null,-1)),st={name:"ConsoleDisplayer",data(){return{autoScroll:!0,logColorAnsiMap:{"\x1B[1;34m":"color: #0000FF; font-weight: bold;","\x1B[1;36m":"color: #00FFFF; font-weight: bold;","\x1B[1;33m":"color: #FFFF00; font-weight: bold;","\x1B[31m":"color: #FF0000;","\x1B[1;31m":"color: #FF0000; font-weight: bold;","\x1B[0m":"color: inherit; font-weight: normal;","\x1B[32m":"color: #00FF00;",default:"color: #FFFFFF;"},logLevels:["DEBUG","INFO","WARNING","ERROR","CRITICAL"],selectedLevels:[0,1,2,3,4],levelColors:{DEBUG:"grey",INFO:"blue-lighten-3",WARNING:"amber",ERROR:"red",CRITICAL:"purple"},localLogCache:[],eventSource:null,retryTimer:null,retryAttempts:0,maxRetryAttempts:10,baseRetryDelay:1e3,lastEventId:null}},computed:{commonStore(){return Pe()}},props:{historyNum:{type:String,default:"-1"},showLevelBtns:{type:Boolean,default:!0}},watch:{selectedLevels:{handler(){this.refreshDisplay()},deep:!0}},async mounted(){await this.fetchLogHistory(),this.connectSSE()},beforeUnmount(){this.eventSource&&(this.eventSource.close(),this.eventSource=null),this.retryTimer&&(clearTimeout(this.retryTimer),this.retryTimer=null),this.retryAttempts=0},methods:{connectSSE(){this.eventSource&&(this.eventSource.close(),this.eventSource=null),console.log(`正在连接日志流... (尝试次数: ${this.retryAttempts})`);const c=localStorage.getItem("token");this.eventSource=new nt.EventSourcePolyfill("/api/live-log",{headers:{Authorization:c?`Bearer ${c}`:""},heartbeatTimeout:3e5,withCredentials:!0}),this.eventSource.onopen=()=>{console.log("日志流连接成功！"),this.retryAttempts=0,this.lastEventId||this.fetchLogHistory()},this.eventSource.onmessage=u=>{try{u.lastEventId&&(this.lastEventId=u.lastEventId);const s=JSON.parse(u.data);this.processNewLogs([s])}catch(s){console.error("解析日志失败:",s)}},this.eventSource.onerror=u=>{if(u.status===401?console.error("鉴权失败 (401)，可能是 Token 过期了。"):console.warn("日志流连接错误:",u),this.eventSource&&(this.eventSource.close(),this.eventSource=null),this.retryAttempts>=this.maxRetryAttempts){console.error("❌ 已达到最大重试次数，停止重连。请刷新页面重试。");return}const s=Math.min(this.baseRetryDelay*Math.pow(2,this.retryAttempts),3e4);console.log(`⏳ ${s}ms 后尝试第 ${this.retryAttempts+1} 次重连...`),this.retryTimer&&(clearTimeout(this.retryTimer),this.retryTimer=null),this.retryTimer=setTimeout(async()=>{this.retryAttempts++,this.lastEventId||await this.fetchLogHistory(),this.connectSSE()},s)}},processNewLogs(c){if(!c||c.length===0)return;let u=!1;if(c.forEach(s=>{this.localLogCache.some(S=>S.time===s.time&&S.data===s.data&&S.level===s.level)||(this.localLogCache.push(s),u=!0,this.isLevelSelected(s.level)&&this.printLog(s.data))}),u){this.localLogCache.sort((y,S)=>y.time-S.time);const s=this.commonStore.log_cache_max_len||200;this.localLogCache.length>s&&this.localLogCache.splice(0,this.localLogCache.length-s)}},async fetchLogHistory(){try{const c=await Ze.get("/api/log-history");c.data.data.logs&&c.data.data.logs.length>0&&this.processNewLogs(c.data.data.logs)}catch(c){console.error("Failed to fetch log history:",c)}},getLevelColor(c){return this.levelColors[c]||"grey"},isLevelSelected(c){for(let u=0;u<this.selectedLevels.length;++u)if(this.logLevels[this.selectedLevels[u]]===c)return!0;return!1},refreshDisplay(){const c=document.getElementById("term");c&&(c.innerHTML="",this.localLogCache&&this.localLogCache.length>0&&this.localLogCache.forEach(u=>{this.isLevelSelected(u.level)&&this.printLog(u.data)}))},toggleAutoScroll(){this.autoScroll=!this.autoScroll},printLog(c){let u=document.getElementById("term");if(!u)return;let s=document.createElement("pre"),y=this.logColorAnsiMap.default;for(let S in this.logColorAnsiMap)if(c.startsWith(S)){y=this.logColorAnsiMap[S],c=c.replace(S,"").replace("\x1B[0m","");break}s.style=y+"display: block; font-size: 12px; font-family: Consolas, monospace; white-space: pre-wrap; margin-bottom: 2px;",s.classList.add("fade-in"),s.innerText=`${c}`,u.appendChild(s),this.autoScroll&&(u.scrollTop=u.scrollHeight)}}},lt=Object.assign(st,{setup(c){return(u,s)=>(ee(),ce("div",null,[c.showLevelBtns?(ee(),ce("div",at,[Xe(Qe,{modelValue:u.selectedLevels,"onUpdate:modelValue":s[0]||(s[0]=y=>u.selectedLevels=y),column:"",multiple:""},{default:Le(()=>[(ee(!0),ce(qe,null,ke(u.logLevels,y=>(ee(),We(Ke,{key:y,color:u.getLevelColor(y),filter:"",variant:"flat",size:"small","text-color":y==="DEBUG"||y==="INFO"?"black":"white",class:"font-weight-medium"},{default:Le(()=>[$e(ze(y),1)]),_:2},1032,["color","text-color"]))),128))]),_:1},8,["modelValue"])])):Je("",!0),it]))}}),ut=rt(lt,[["__scopeId","data-v-6bf2d586"]]);export{ut as C};
