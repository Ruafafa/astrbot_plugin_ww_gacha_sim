import{ae as Q,K as y,r as I,o as m,g as u,b as s,w as a,y as D,C as R,A as r,l as h,D as S,V as J,af as $,ag as ee,B as A,e as d,t as f,p as w,a5 as M,a as C,k as W,ah as te,ai as q,E as oe,a2 as se,H as E,I as x,J as B,z as T,a3 as ae,aj as le,F as Y,u as ie,_ as ne,ak as re,al as U,am as X,h as de,n as fe,Q as j,an as ce,G as me}from"./index-61371d60.js";import{A as F,I as ge}from"./AstrBotConfig-27eff76a.js";import{W as ue}from"./WaitingForRestart-d6ba996f.js";import{C as he}from"./ConsoleDisplayer-69ceb810.js";import{A as pe,C as Ae}from"./ConfigPage-b4a174d0.js";import{_ as K}from"./_plugin-vue_export-helper-c27b6911.js";import{u as we}from"./common-619402c2.js";import"./index-2a23493b.js";import"./PersonaForm-76e4f5a1.js";import"./customizer-e056107a.js";import"./MessageList-fbdd7c7f.js";import"./github-9f73710c.js";import"./useRecording-073e8009.js";function Z(e){if(e==="aiocqhttp")return new URL("/assets/onebot-2ecdbc7f.png",self.location).href;if(e==="qq_official"||e==="qq_official_webhook")return new URL("/assets/qq-7a369eaf.png",self.location).href;if(e==="wecom"||e==="wecom_ai_bot")return new URL("/assets/wecom-7dfcf4e4.png",self.location).href;if(e==="wechatpadpro"||e==="weixin_official_account"||e==="wechat")return new URL("/assets/wechat-6a207b66.png",self.location).href;if(e==="lark")return new URL("data:image/png;base64,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",self.location).href;if(e==="dingtalk")return new URL("/assets/dingtalk-c6437bfa.svg",self.location).href;if(e==="telegram")return new URL("/assets/telegram-e782a1bf.svg",self.location).href;if(e==="discord")return new URL("/assets/discord-a137e6ae.svg",self.location).href;if(e==="slack")return new URL("/assets/slack-c0af31c6.svg",self.location).href;if(e==="kook")return new URL("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEABAMAAACuXLVVAAAAIVBMVEVHcEyI7ACJ7gCH7AAAAACH6wD///8qPBSMjIxYmQDHx8eQCYoRAAAABHRSTlMAk0fUckCvPAAABmBJREFUeNrVnctuIjkUhqtpZZ+0xD4diX0kVG8A4bIKFwuxR4BYF3TPHqFWr4nmBRCaxxxlMkk3VbbrXGz/tJVVRUp9cZ3zlcu2fLLM0R7u2m0TqLXbdw8ZqzW+5iZwm3xh3D/87VkIjaaJ1Eb3lPt/yk20Nrkl3N9EbbUEX03k9gX6/9f2QSOPDzDxRWKC+3tzoWWStDEwALxh0MhTATjCoGWSNetDaJiEzdYFzZQAI2AEuuKwmRZgBO6Aahe0UgOMgSlgS4RWeoBx+rdQSYfQECyHYQsBMIaG4GUYfsYA3GKfwO/PIMcATKA58PszaKEAnjEvwuor0cAaOATeg+AGB/CMDYH3IMhxABPgi+DX6+ATEuAWG4NvUdhCAoyxSfCWBjkSYAIV8ZuMG1iAe2wWvubhZyzAI1YDryJoYQHGeIAmFmCEB8ixABMCwN/f1E0HcOyo24sKoNADdD0AJgXAwPM2qgfoBGgagHkIgC0aoKsAmIUA6CkApiEA3ImYCmArBzgGARjIAYpO1CBIBeAMgiyJhzyJmAxgIAUoeejHPz8vft6v90vX91QbZzwP9ZaXbf3+i3PpF3tqIjIB+qX7rP6/PixdXxbUIMh4HnIBHMoA5ETMeB4q/6cLO9dyQ34lMwGeSjc6vV3eLV2xoQe4fJg7a6yVQ9MKIH0El3/lYI21Sgd8xEZ0AHsOfsQGwUQZz0NnW6xVcvAjNgKkYQnAGuzVDrB4SApAEGF/SQIQmpDgoYMFoCC/j3kANg/1LPdfdoIB1HtoZ7k/3UO1ALUesnbAPiGAJQetb4KeEKBWhJYctFlAOiLye2hp7wBbDgQCqHa1LQdXAQeldR7qUzvA+WmU6QZk1BwUA9SIkJyD4g+TmgHZjpiDnjmSTCVCag7KAfwe+knvAOnHqd9DZ2oOxgIg56B4fqBGhPQOcM9SZQoR0nNQDOAXIVlC8jkiv4foOSieJfMPyMg5KAfwe4jRAR3hRKXfQ+QcTAawCj5Vy/RQIVgwyAJ6aN2JDCCVkHy6nuehTfgFixnLQ6fwACwRbmTrdpl8QEbOQfmiFUuERQQAjodWsiUjPwDHQ/sYC5cMgHWMlVOOh07CZcNQAJtODACGCE/SlVsvAMNDhXT/AANgKM1BOQDdQ3VLe0YGQPbQWrx0feUAdA8V4h0cPgDGgGyfAmApz4KuDIDhoY3YQ3SAvnwwIAXgDMhOUg/5ADgDspXUQ3SAJ/mIVArA+jDcCz3kA2B9GC6EGqADnMXfhVIA5pep0ENkgF6UL1MvAHOGbCXzkAeAOUO2kXmIDDBUzA8JARLMkPkBuDNkK5GHyABlDx3oQSAF8IvwOz0RBzKAGg/16EEQBqDS3weyjbsygLolyyeyjbchAKpLln1yEAgB/CJc2EbJK4GH3AD+AdnJZoa1wENUAMvejSHVxkIAyd6NE99DboD6PWRnWhAMggCcLRm3o9lYCEDYwkUMgq4MYOYFWDsGSYtYAPbNtDQbb2UAlL2sNBu/yAAoe1n7pCgMAuDYy0oCMDIAyl7WahCs2R4iAtj3slYTcRUOgLKZtpqIC7aHXADzehHarp9iAbhibSfey1oHQNzUPxTvZa0DoO2pr5AViQAWrujke8gFcOmh/o/Ltnf9hu8hGoCmCQGKUPfvCQGCdcDgTwUI9gi66CCUAsxCAWxNkLehvL2YIOMBAMA0kYeoHybRPET9NAMAHNN4iDpDEk0D5Fmy9ABhEnGrADgm0QB5wQIAYJJ4iL5uCACYpvAQffU8kocYWzgAAN42F+R8UIBqjL4kBjiiAWb8lAsLYOAABTvnAwNM2SkXGGCOBjDcsYcdIDeBElHmoYkGYIoGmAfwkArgMhGlAE0TKAhkf0J3MttM76GR7nA8PYDydL5C7aFxdqMBmKo99Kw7InKuBnhUHpKp9ZC5VR4TelRqwNwrAaZ6AN0JiXOlhybqw3ILrQi1xwUftR7KdCL4sPFAqgHtkdHzTvFf+0uahVdwaDb82HD8wek3OIDn6zg8H14+AF9AoYUCGF9LEQ14GRF8IRXQ0eGPv6rpQJPwGsoJ4QsqwUtK4YtqwcuKwQur4UvLwYvr4csLwgss4ktMwots4suMwgut4kvNJnoIvnK/8HLD8ILL+JLT+KLb+LLj+MLr+NLzcRBYt39tD3ftdqibt9t3D677/Avbr+yaBnzmVgAAAABJRU5ErkJggg==",self.location).href;if(e==="vocechat")return new URL("/assets/vocechat-77bce3e6.png",self.location).href;if(e==="satori"||e==="Satori")return new URL("/assets/satori-7f1988af.png",self.location).href;if(e==="misskey")return new URL("/assets/misskey-9f74289e.png",self.location).href}function ve(e){return{qq_official_webhook:"https://docs.astrbot.app/deploy/platform/qqofficial/webhook.html",qq_official:"https://docs.astrbot.app/deploy/platform/qqofficial/websockets.html",aiocqhttp:"https://docs.astrbot.app/deploy/platform/aiocqhttp/napcat.html",wecom:"https://docs.astrbot.app/deploy/platform/wecom.html",wecom_ai_bot:"https://docs.astrbot.app/deploy/platform/wecom_ai_bot.html",lark:"https://docs.astrbot.app/deploy/platform/lark.html",telegram:"https://docs.astrbot.app/deploy/platform/telegram.html",dingtalk:"https://docs.astrbot.app/deploy/platform/dingtalk.html",wechatpadpro:"https://docs.astrbot.app/deploy/platform/wechat/wechatpadpro.html",weixin_official_account:"https://docs.astrbot.app/deploy/platform/weixin-official-account.html",discord:"https://docs.astrbot.app/deploy/platform/discord.html",slack:"https://docs.astrbot.app/deploy/platform/slack.html",kook:"https://docs.astrbot.app/deploy/platform/kook.html",vocechat:"https://docs.astrbot.app/deploy/platform/vocechat.html",satori:"https://docs.astrbot.app/deploy/platform/satori/llonebot.html",misskey:"https://docs.astrbot.app/deploy/platform/misskey.html"}[e]||"https://docs.astrbot.app"}function Ce(e,t){return t.includes("vocechat")?"由 @HikariFroya 提供。":t.includes("kook")?"由 @wuyan1003 提供。":""}const be={name:"AddNewPlatform",components:{AstrBotConfig:F,AstrBotCoreConfigWrapper:pe,ConfigPage:Ae},emits:["update:show","show-toast","refresh-config"],props:{show:{type:Boolean,default:!1},metadata:{type:Object,default:()=>({})},config_data:{type:Object,default:()=>({})},updatingMode:{type:Boolean,default:!1},updatingPlatformConfig:{type:Object,default:null}},data(){return{selectedPlatformType:null,selectedPlatformConfig:null,aBConfigRadioVal:"0",selectedAbConfId:"default",configInfoList:[],selectedConfigData:null,selectedConfigMetadata:null,configPreviewLoading:!1,newConfigData:null,newConfigMetadata:null,newConfigLoading:!1,platformConfigs:[],configTableHeaders:[{title:"与此实例关联的配置文件 ID",key:"name",sortable:!1},{title:"在此实例下的应用范围",key:"scope",sortable:!1}],platformRoutes:[],routeTableHeaders:[{title:"消息会话来源(消息类型:会话 ID)",key:"source",sortable:!1,width:"60%"},{title:"使用配置文件",key:"configId",sortable:!1,width:"20%"},{title:"操作",key:"actions",sortable:!1,align:"center",width:"20%"}],messageTypeOptions:[{label:"全部消息",value:"*"},{label:"群组消息(GroupMessage)",value:"GroupMessage"},{label:"私聊消息(FriendMessage)",value:"FriendMessage"}],isEditingRoutes:!1,showIdConflictDialog:!1,conflictId:"",idConflictResolve:null,showOneBotEmptyTokenWarnDialog:!1,oneBotEmptyTokenWarningResolve:null,loading:!1,showConfigSection:!1,showConfigDrawer:!1,configDrawerTargetId:null,originalUpdatingPlatformId:null}},setup(){const{tm:e}=Q("features/platform");return{tm:e}},computed:{showDialog:{get(){return this.show},set(e){this.$emit("update:show",e)}},platformTemplates(){var e,t,n;return((n=(t=(e=this.metadata.platform_group)==null?void 0:e.metadata)==null?void 0:t.platform)==null?void 0:n.config_template)||{}},canSave(){return this.selectedPlatformType?this.aBConfigRadioVal==="0"?!!this.selectedAbConfId:this.aBConfigRadioVal==="1"?!!(this.selectedAbConfId&&this.newConfigData):!1:!1}},watch:{selectedPlatformType(e){e&&this.platformTemplates[e]?this.selectedPlatformConfig=JSON.parse(JSON.stringify(this.platformTemplates[e])):this.selectedPlatformConfig=null},selectedAbConfId(e){!this.updatingMode&&this.aBConfigRadioVal==="0"&&e?this.getConfigForPreview(e):(this.selectedConfigData=null,this.selectedConfigMetadata=null)},aBConfigRadioVal(e){e==="1"?(this.selectedConfigData=null,this.selectedConfigMetadata=null,this.selectedAbConfId=null,this.getDefaultConfigTemplate()):e==="0"&&(this.newConfigData=null,this.newConfigMetadata=null,this.selectedAbConfId||(this.selectedAbConfId="default"))},showIdConflictDialog(e){!e&&this.idConflictResolve&&(this.idConflictResolve(!1),this.idConflictResolve=null)},showOneBotEmptyTokenWarnDialog(e){!e&&this.oneBotEmptyTokenWarningResolve&&(this.oneBotEmptyTokenWarningResolve(!0),this.oneBotEmptyTokenWarningResolve=null)},updatingPlatformConfig:{handler(e){this.updatingMode&&e&&e.id&&(this.originalUpdatingPlatformId=e.id,this.getPlatformConfigs(e.id))},immediate:!0},showConfigSection(e){e&&!this.updatingMode&&this.aBConfigRadioVal==="0"&&this.getConfigForPreview(this.selectedAbConfId),e&&this.$nextTick(()=>{this.scrollDialogToBottom()})},updatingMode:{handler(e){e&&(this.showConfigSection=!0,this.isEditingRoutes=!1)},immediate:!0}},methods:{getPlatformIcon:Z,getPlatformDescription:Ce,resetForm(){this.selectedPlatformType=null,this.selectedPlatformConfig=null,this.aBConfigRadioVal="0",this.selectedAbConfId="default",this.selectedConfigData=null,this.selectedConfigMetadata=null,this.configPreviewLoading=!1,this.newConfigData=null,this.newConfigMetadata=null,this.newConfigLoading=!1,this.showConfigSection=!1,this.isEditingRoutes=!1,this.showConfigDrawer=!1,this.configDrawerTargetId=null,this.originalUpdatingPlatformId=null},closeDialog(){this.resetForm(),this.showDialog=!1},async getConfigInfoList(){await y.get("/api/config/abconfs").then(e=>{this.configInfoList=e.data.data.info_list})},async getConfigForPreview(e){if(!e){this.selectedConfigData=null,this.selectedConfigMetadata=null;return}this.configPreviewLoading=!0;try{const t=await y.get("/api/config/abconf",{params:{id:e}});this.selectedConfigData=t.data.data.config,this.selectedConfigMetadata=t.data.data.metadata}catch(t){console.error("获取配置文件预览数据失败:",t),this.selectedConfigData=null,this.selectedConfigMetadata=null}finally{this.configPreviewLoading=!1}},async getDefaultConfigTemplate(){this.newConfigLoading=!0;try{const e=await y.get("/api/config/default");this.newConfigData=e.data.data.config,this.newConfigMetadata=e.data.data.metadata}catch(e){console.error("获取默认配置模板失败:",e),this.newConfigData=null,this.newConfigMetadata=null}finally{this.newConfigLoading=!1}},openTutorial(){const e=ve(this.selectedPlatformConfig.type);window.open(e,"_blank")},openConfigDrawer(e){const t=e||"default";e&&this.configInfoList.findIndex(n=>n.id===e)===-1&&this.showError("目标配置文件不存在，已打开配置页面以便检查。"),this.configDrawerTargetId=t,this.showConfigDrawer=!0},closeConfigDrawer(){this.showConfigDrawer=!1},newPlatform(){if(this.loading=!0,this.updatingMode){if(this.updatingPlatformConfig.type==="aiocqhttp"){const e=this.updatingPlatformConfig.ws_reverse_token;if(!e||e.trim()===""){this.showOneBotEmptyTokenWarning().then(t=>{t?this.updatePlatform():this.loading=!1});return}}this.updatePlatform()}else this.savePlatform()},async updatePlatform(){var t,n;const e=this.originalUpdatingPlatformId||this.updatingPlatformConfig.id;if(!e){this.loading=!1,this.showError("更新失败，缺少平台 ID。");return}try{let l=await y.post("/api/config/platform/update",{id:e,config:this.updatingPlatformConfig});if(l.data.status==="error")throw new Error(l.data.message||"平台更新失败");await this.saveRoutesInternal(),this.loading=!1,this.showDialog=!1,this.resetForm(),this.$emit("refresh-config"),this.showSuccess("更新成功")}catch(l){this.loading=!1,this.showError(((n=(t=l.response)==null?void 0:t.data)==null?void 0:n.message)||l.message)}},async savePlatform(){var t,n,l;if((((t=this.config_data.platform)==null?void 0:t.find(o=>o.id===this.selectedPlatformConfig.id))||this.selectedPlatformConfig.id==="webchat")&&!await this.confirmIdConflict(this.selectedPlatformConfig.id)){this.loading=!1;return}if(this.selectedPlatformConfig.type==="aiocqhttp"){const o=this.selectedPlatformConfig.ws_reverse_token;if((!o||o.trim()==="")&&!await this.showOneBotEmptyTokenWarning())return}try{const o=await y.post("/api/config/platform/new",this.selectedPlatformConfig);await this.handleConfigFile(),this.loading=!1,this.showDialog=!1,this.resetForm(),this.$emit("refresh-config"),this.showSuccess(o.data.message||"平台添加成功，配置文件已更新")}catch(o){this.loading=!1,this.showError(((l=(n=o.response)==null?void 0:n.data)==null?void 0:l.message)||o.message)}},async handleConfigFile(){if(!this.selectedAbConfId)return;const t=`${this.selectedPlatformConfig.id}:*:*`;let n=null;if(this.aBConfigRadioVal==="0"?n=this.selectedAbConfId:this.aBConfigRadioVal==="1"&&(n=await this.createNewConfigFile(this.selectedAbConfId)),!n)throw new Error("无法获取配置文件ID");await this.updateRoutingTable(t,n)},async updateRoutingTable(e,t){var n,l;try{await y.post("/api/config/umo_abconf_route/update",{umo:e,conf_id:t}),console.log(`成功更新路由表: ${e} -> ${t}`)}catch(o){throw console.error("更新路由表失败:",o),new Error(`更新路由表失败: ${((l=(n=o.response)==null?void 0:n.data)==null?void 0:l.message)||o.message}`)}},async createNewConfigFile(e){var t,n;try{const l=this.aBConfigRadioVal==="1"&&this.newConfigData?this.newConfigData:void 0,i=(await y.post("/api/config/abconf/new",{name:e,config:l})).data.data.conf_id;return console.log(`成功创建新配置文件 ${e}，ID: ${i}`),i}catch(l){throw console.error("创建新配置文件失败:",l),new Error(`创建新配置文件失败: ${((n=(t=l.response)==null?void 0:t.data)==null?void 0:n.message)||l.message}`)}},confirmIdConflict(e){return this.conflictId=e,this.showIdConflictDialog=!0,new Promise(t=>{this.idConflictResolve=t})},handleIdConflictConfirm(e){this.idConflictResolve&&this.idConflictResolve(e),this.showIdConflictDialog=!1},showOneBotEmptyTokenWarning(){return this.showOneBotEmptyTokenWarnDialog=!0,new Promise(e=>{this.oneBotEmptyTokenWarningResolve=e})},handleOneBotEmptyTokenWarningDismiss(e){this.showOneBotEmptyTokenWarnDialog=!1,this.oneBotEmptyTokenWarningResolve&&(this.oneBotEmptyTokenWarningResolve(e),this.oneBotEmptyTokenWarningResolve=null),e||(this.loading=!1)},showSuccess(e){this.$emit("show-toast",{message:e,type:"success"})},showError(e){this.$emit("show-toast",{message:e,type:"error"})},async getPlatformConfigs(e){if(!e){this.platformRoutes=[];return}try{const n=(await y.get("/api/config/umo_abconf_routes")).data.data.routing,l=[];for(const[o,i]of Object.entries(n))if(this.isUmopMatchPlatform(o,e)){const v=o.split(":");v.length===3&&l.push({umop:o,originalUmop:o,messageType:v[1]===""||v[1]==="*"?"*":v[1],sessionId:v[2]===""||v[2]==="*"?"*":v[2],configId:i})}this.platformRoutes=l,this.platformRoutes.length===0&&this.platformRoutes.push({umop:null,originalUmop:null,messageType:"*",sessionId:"*",configId:"default"})}catch(t){console.error("获取平台路由配置失败:",t),this.platformRoutes=[]}},addNewRoute(){this.platformRoutes.push({umop:null,originalUmop:null,messageType:"*",sessionId:"*",configId:"default"})},deleteRoute(e){this.platformRoutes.splice(e,1)},moveRouteUp(e){if(e>0){const t=this.platformRoutes[e];this.platformRoutes[e]=this.platformRoutes[e-1],this.platformRoutes[e-1]=t,this.platformRoutes=[...this.platformRoutes]}},moveRouteDown(e){if(e<this.platformRoutes.length-1){const t=this.platformRoutes[e];this.platformRoutes[e]=this.platformRoutes[e+1],this.platformRoutes[e+1]=t,this.platformRoutes=[...this.platformRoutes]}},async saveRoutesInternal(){var n,l,o,i;const e=this.originalUpdatingPlatformId||((n=this.updatingPlatformConfig)==null?void 0:n.id),t=((l=this.updatingPlatformConfig)==null?void 0:l.id)||e;if(!e&&!t)throw new Error("无法获取平台 ID");try{const _=(await y.get("/api/config/umo_abconf_routes")).data.data.routing;for(const b in _)(e&&this.isUmopMatchPlatform(b,e)||t&&this.isUmopMatchPlatform(b,t))&&delete _[b];for(const b of this.platformRoutes){const g=b.messageType==="*"?"*":b.messageType,P=b.sessionId==="*"?"*":b.sessionId,p=`${t||e}:${g}:${P}`;b.configId&&(_[p]=b.configId)}await y.post("/api/config/umo_abconf_route/update_all",{routing:_})}catch(v){throw console.error("保存路由表失败:",v),new Error(`保存路由表失败: ${((i=(o=v.response)==null?void 0:o.data)==null?void 0:i.message)||v.message}`)}},toggleEditMode(){this.isEditingRoutes=!this.isEditingRoutes},toggleConfigSection(){this.showConfigSection=!this.showConfigSection},getConfigName(e){const t=this.configInfoList.find(n=>n.id===e);return t?t.name:e},isUmopMatchPlatform(e,t){if(!e)return!1;const n=e.split(":");if(n.length!==3)return!1;const l=n[0];return l===t||l===""||l==="*"},getMessageTypeLabel(e){return{"*":"全部消息","":"全部消息",GroupMessage:"群组消息",FriendMessage:"私聊消息"}[e]||e},toggleShowConfigSection(){this.showConfigSection=!1,this.showConfigSection=!0},prepareData(){this.getConfigInfoList(),this.getConfigForPreview(this.selectedAbConfId),this.updatingMode&&this.updatingPlatformConfig&&this.updatingPlatformConfig.id&&this.getPlatformConfigs(this.updatingPlatformConfig.id)},scrollDialogToBottom(){const e=this.$refs.dialogScrollContainer,t=(e==null?void 0:e.$el)||e;if(!t)return;const n={top:t.scrollHeight,behavior:"smooth"};typeof t.scrollTo=="function"?t.scrollTo(n):t.scrollTop=t.scrollHeight}}},ye={class:"d-flex align-start",style:{width:"100%"}},_e={style:{flex:"1"}},ke=r("h3",null," 选择消息平台类别 ",-1),De=r("small",{style:{color:"grey"}},"想把机器人接入到哪里？如 QQ、企业微信、飞书、Discord、Telegram 等。",-1),Pe={key:0},Ie=["src"],Re={key:0,class:"mt-3"},xe={class:"mt-2"},Ve={key:1},Ee={class:"mt-3"},Be={class:"mt-2"},Te={class:"d-flex align-start mt-6"},Se={style:{flex:"1"}},Me={class:"d-flex align-center justify-space-between"},We={class:"d-flex align-center"},Ue=r("h3",null," 配置文件 ",-1),Oe=r("small",{style:{color:"grey"}},"想如何配置机器人？配置文件包含了聊天模型、人格、知识库、插件范围等丰富的机器人配置项。",-1),Le={key:0,style:{color:"grey"}},Ne={key:0},Ge={key:0},He=r("span",null,"使用现有配置文件",-1),ze={key:0,class:"d-flex align-center ml-10 my-2"},qe={key:1,class:"d-flex align-center"},Xe={key:0,class:"mt-4"},je={key:0,class:"d-flex justify-center py-4"},Qe={key:1,class:"config-preview-container"},Ye=r("h4",{class:"mb-3"},"使用新的配置文件",-1),Fe={key:2,class:"text-center py-4 text-grey"},Ke=r("p",{class:"mt-2"},"无法加载默认配置模板",-1),Ze={key:1},Je={class:"mb-3 d-flex align-center justify-space-between"},$e={class:"d-flex align-center",style:{"min-width":"250px"}},et={key:1},tt=r("small",{class:"mx-1"},":",-1),ot={key:3},st={class:"d-flex align-center"},at={key:1},lt={key:0,style:{color:"red"},class:"ml-2"},it={key:0,class:"d-flex align-center"},nt={key:1,class:"text-grey"},rt=r("small",{class:"ml-2 mt-2 d-block",style:{color:"grey"}},"*消息下发时，根据会话来源按顺序从上到下匹配首个符合条件的配置文件。使用 * 表示匹配所有。使用 /sid 指令获取会话 ID。全部不匹配时将使用默认配置文件。",-1),dt={href:"https://docs.astrbot.app/deploy/platform/aiocqhttp/napcat.html#%E9%99%84%E5%BD%95-%E5%A2%9E%E5%BC%BA%E8%BF%9E%E6%8E%A5%E5%AE%89%E5%85%A8%E6%80%A7",target:"_blank"},ft={class:"config-drawer-header"},ct=r("span",{class:"text-h6"},"配置文件管理",-1),mt={key:0,class:"text-caption text-grey"},gt={class:"config-drawer-content"};function ut(e,t,n,l,o,i){const v=I("AstrBotConfig"),_=I("AstrBotCoreConfigWrapper"),b=I("ConfigPage");return m(),u(Y,null,[s(B,{modelValue:i.showDialog,"onUpdate:modelValue":t[6]||(t[6]=g=>i.showDialog=g),"max-width":"800px",height:"90%",onAfterEnter:i.prepareData},{default:a(()=>[s(D,{title:n.updatingMode?`${l.tm("dialog.edit")} ${n.updatingPlatformConfig.id} ${l.tm("dialog.adapter")}`:l.tm("dialog.addPlatform")},{default:a(()=>[s(R,{ref:"dialogScrollContainer",class:"pa-4 ml-2",style:{"overflow-y":"auto"}},{default:a(()=>{var g,P;return[r("div",ye,[r("div",null,[s(h,{icon:"mdi-numeric-1-circle",class:"mr-3"})]),r("div",_e,[ke,De,r("div",null,[n.updatingMode?(m(),u("div",Ve,[s(M,{label:"消息平台类别",variant:"outlined",rounded:"md",dense:"","hide-details":"",class:"mt-6",style:{"max-width":"30%","min-width":"300px"},modelValue:n.updatingPlatformConfig.type,"onUpdate:modelValue":t[1]||(t[1]=c=>n.updatingPlatformConfig.type=c),disabled:""},null,8,["modelValue"]),r("div",Ee,[r("div",Be,[s(v,{iterable:n.updatingPlatformConfig,metadata:(P=n.metadata.platform_group)==null?void 0:P.metadata,metadataKey:"platform"},null,8,["iterable","metadata"])])])])):(m(),u("div",Pe,[s(S,{modelValue:o.selectedPlatformType,"onUpdate:modelValue":t[0]||(t[0]=c=>o.selectedPlatformType=c),items:Object.keys(i.platformTemplates),"item-title":"name","item-value":"name",label:"消息平台类别",variant:"outlined",rounded:"md",dense:"","hide-details":"",class:"mt-6",style:{"max-width":"30%","min-width":"300px"}},{item:a(({props:c,item:p})=>[s(J,$(ee(c)),{prepend:a(()=>[r("img",{src:i.getPlatformIcon(i.platformTemplates[p.raw].type),style:{width:"32px",height:"32px","object-fit":"contain","margin-right":"16px"}},null,8,Ie)]),_:2},1040)]),_:1},8,["modelValue","items"]),o.selectedPlatformConfig?(m(),u("div",Re,[s(A,{color:"info",variant:"tonal",onClick:i.openTutorial,class:"mt-2"},{default:a(()=>[s(h,{start:""},{default:a(()=>[d("mdi-book-open-variant")]),_:1}),d(" "+f(l.tm("dialog.viewTutorial")),1)]),_:1},8,["onClick"]),r("div",xe,[s(v,{iterable:o.selectedPlatformConfig,metadata:(g=n.metadata.platform_group)==null?void 0:g.metadata,metadataKey:"platform"},null,8,["iterable","metadata"])])])):w("",!0)]))])])]),r("div",Te,[r("div",null,[s(h,{icon:"mdi-numeric-2-circle",class:"mr-3"})]),r("div",Se,[r("div",Me,[r("div",null,[r("div",We,[Ue,n.updatingMode?w("",!0):(m(),C(W,{key:0,size:"x-small",color:"primary",variant:"tonal",rounded:"sm",class:"ml-2"},{default:a(()=>[d("可选")]),_:1}))]),Oe,n.updatingMode?w("",!0):(m(),u("small",Le,"默认使用默认配置文件 “default”。您也可以稍后配置。"))]),r("div",null,[s(A,{variant:"plain",icon:"",onClick:i.toggleConfigSection,class:"mt-2"},{default:a(()=>[s(h,null,{default:a(()=>[d(f(o.showConfigSection?"mdi-chevron-up":"mdi-chevron-down"),1)]),_:1})]),_:1},8,["onClick"])])]),o.showConfigSection?(m(),u("div",Ne,[n.updatingMode?(m(),u("div",Ze,[r("div",Je,[r("div",null,[o.isEditingRoutes?(m(),C(A,{key:0,color:"primary",variant:"tonal",onClick:i.addNewRoute,size:"small"},{default:a(()=>[s(h,{start:""},{default:a(()=>[d("mdi-plus")]),_:1}),d(" 添加路由规则 ")]),_:1},8,["onClick"])):w("",!0)]),s(A,{color:o.isEditingRoutes?"grey":"primary",variant:"tonal",size:"small",onClick:i.toggleEditMode},{default:a(()=>[s(h,{start:""},{default:a(()=>[d(f(o.isEditingRoutes?"mdi-eye":"mdi-pencil"),1)]),_:1}),d(" "+f(o.isEditingRoutes?"查看":"编辑"),1)]),_:1},8,["color","onClick"])]),s(se,{headers:o.routeTableHeaders,items:o.platformRoutes,"item-value":"umop","no-data-text":"该平台暂无路由规则，将使用默认配置文件","hide-default-footer":"","items-per-page":-1,class:"mt-2",variant:"outlined"},{"item.source":a(({item:c})=>[r("div",$e,[o.isEditingRoutes?(m(),C(S,{key:0,modelValue:c.messageType,"onUpdate:modelValue":p=>c.messageType=p,items:o.messageTypeOptions,"item-title":"label","item-value":"value",variant:"outlined",density:"compact","hide-details":"",style:{"max-width":"140px"}},null,8,["modelValue","onUpdate:modelValue","items"])):(m(),u("small",et,f(i.getMessageTypeLabel(c.messageType)),1)),tt,o.isEditingRoutes?(m(),C(M,{key:2,modelValue:c.sessionId,"onUpdate:modelValue":p=>c.sessionId=p,variant:"outlined",density:"compact","hide-details":"",placeholder:"会话ID或*"},null,8,["modelValue","onUpdate:modelValue"])):(m(),u("small",ot,f(c.sessionId==="*"?"全部会话":c.sessionId),1))])]),"item.configId":a(({item:c})=>[r("div",st,[o.isEditingRoutes?(m(),C(S,{key:0,modelValue:c.configId,"onUpdate:modelValue":p=>c.configId=p,items:o.configInfoList,"item-title":"name","item-value":"id",variant:"outlined",density:"compact",style:{"min-width":"200px"},"hide-details":""},null,8,["modelValue","onUpdate:modelValue","items"])):(m(),u("div",at,[r("small",null,f(i.getConfigName(c.configId)),1)])),s(A,{icon:"",variant:"text",density:"compact",class:"ml-2",disabled:!c.configId,onClick:p=>i.openConfigDrawer(c.configId)},{default:a(()=>[s(h,{size:"18"},{default:a(()=>[d("mdi-arrow-top-right-thick")]),_:1})]),_:2},1032,["disabled","onClick"])]),o.configInfoList.findIndex(p=>p.id===c.configId)===-1?(m(),u("small",lt,"配置文件不存在")):w("",!0)]),"item.actions":a(({item:c,index:p})=>[o.isEditingRoutes?(m(),u("div",it,[s(A,{icon:"",size:"x-small",variant:"text",onClick:V=>i.moveRouteUp(p),disabled:p===0},{default:a(()=>[s(h,null,{default:a(()=>[d("mdi-arrow-up")]),_:1})]),_:2},1032,["onClick","disabled"]),s(A,{icon:"",size:"x-small",variant:"text",onClick:V=>i.moveRouteDown(p),disabled:p===o.platformRoutes.length-1},{default:a(()=>[s(h,null,{default:a(()=>[d("mdi-arrow-down")]),_:1})]),_:2},1032,["onClick","disabled"]),s(A,{icon:"",size:"x-small",variant:"text",color:"error",onClick:V=>i.deleteRoute(p)},{default:a(()=>[s(h,null,{default:a(()=>[d("mdi-delete")]),_:1})]),_:2},1032,["onClick"])])):(m(),u("span",nt,"-"))]),_:1},8,["headers","items"]),rt])):(m(),u("div",Ge,[s(te,{class:"mt-2",modelValue:o.aBConfigRadioVal,"onUpdate:modelValue":t[5]||(t[5]=c=>o.aBConfigRadioVal=c),"hide-details":"true"},{default:a(()=>[s(q,{value:"0"},{label:a(()=>[He]),_:1}),o.aBConfigRadioVal==="0"?(m(),u("div",ze,[s(S,{modelValue:o.selectedAbConfId,"onUpdate:modelValue":t[2]||(t[2]=c=>o.selectedAbConfId=c),items:o.configInfoList,"item-title":"name","item-value":"id",label:"选择配置文件",variant:"outlined",rounded:"md",dense:"","hide-details":"",style:{"max-width":"30%","min-width":"200px"}},null,8,["modelValue","items"]),s(A,{icon:"",variant:"text",density:"comfortable",class:"ml-2",disabled:!o.selectedAbConfId,onClick:t[3]||(t[3]=c=>i.openConfigDrawer(o.selectedAbConfId))},{default:a(()=>[s(h,null,{default:a(()=>[d("mdi-arrow-top-right-thick")]),_:1})]),_:1},8,["disabled"])])):w("",!0),s(q,{value:"1",label:"创建新配置文件"}),o.aBConfigRadioVal==="1"?(m(),u("div",qe,[s(M,{modelValue:o.selectedAbConfId,"onUpdate:modelValue":t[4]||(t[4]=c=>o.selectedAbConfId=c),label:"新配置文件名称",variant:"outlined",rounded:"md",dense:"","hide-details":"",style:{"max-width":"30%","min-width":"200px"},class:"ml-10 my-2"},null,8,["modelValue"])])):w("",!0)]),_:1},8,["modelValue"]),o.aBConfigRadioVal==="1"?(m(),u("div",Xe,[o.newConfigLoading?(m(),u("div",je,[s(oe,{indeterminate:"",color:"primary"})])):o.newConfigData&&o.newConfigMetadata?(m(),u("div",Qe,[Ye,s(_,{metadata:o.newConfigMetadata,config_data:o.newConfigData},null,8,["metadata","config_data"])])):(m(),u("div",Fe,[s(h,null,{default:a(()=>[d("mdi-information-outline")]),_:1}),Ke]))])):w("",!0)]))])):w("",!0)])])]}),_:1},512),s(E,null,{default:a(()=>[s(x),s(A,{text:"",onClick:i.closeDialog},{default:a(()=>[d(f(l.tm("dialog.cancel")),1)]),_:1},8,["onClick"]),n.updatingMode?(m(),C(A,{key:1,disabled:!o.selectedAbConfId,color:"primary",onClick:i.newPlatform,loading:o.loading},{default:a(()=>[d(f(l.tm("dialog.save")),1)]),_:1},8,["disabled","onClick","loading"])):(m(),C(A,{key:0,disabled:!i.canSave,color:"primary",onClick:i.newPlatform,loading:o.loading},{default:a(()=>[d(f(l.tm("dialog.save")),1)]),_:1},8,["disabled","onClick","loading"]))]),_:1})]),_:1},8,["title"])]),_:1},8,["modelValue","onAfterEnter"]),s(B,{modelValue:o.showIdConflictDialog,"onUpdate:modelValue":t[8]||(t[8]=g=>o.showIdConflictDialog=g),"max-width":"450",persistent:""},{default:a(()=>[s(D,null,{default:a(()=>[s(T,{class:"text-h6 bg-warning d-flex align-center"},{default:a(()=>[s(h,{start:"",class:"me-2"},{default:a(()=>[d("mdi-alert-circle-outline")]),_:1}),d(" "+f(l.tm("dialog.idConflict.title")),1)]),_:1}),s(R,{class:"py-4 text-body-1 text-medium-emphasis"},{default:a(()=>[d(f(l.tm("dialog.idConflict.message",{id:o.conflictId})),1)]),_:1}),s(E,null,{default:a(()=>[s(x),s(A,{color:"grey",variant:"text",onClick:t[7]||(t[7]=g=>i.handleIdConflictConfirm(!1))},{default:a(()=>[d(f(l.tm("dialog.idConflict.confirm")),1)]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),s(B,{modelValue:o.showOneBotEmptyTokenWarnDialog,"onUpdate:modelValue":t[11]||(t[11]=g=>o.showOneBotEmptyTokenWarnDialog=g),"max-width":"600",persistent:""},{default:a(()=>[s(D,null,{default:a(()=>[s(T,null,{default:a(()=>[d(f(l.tm("dialog.securityWarning.title")),1)]),_:1}),s(R,{class:"py-4"},{default:a(()=>[r("p",null,f(l.tm("dialog.securityWarning.aiocqhttpTokenMissing")),1),r("span",null,[r("a",dt,f(l.tm("dialog.securityWarning.learnMore")),1)])]),_:1}),s(E,{class:"px-4 pb-4"},{default:a(()=>[s(x),s(A,{color:"error",onClick:t[9]||(t[9]=g=>i.handleOneBotEmptyTokenWarningDismiss(!0))},{default:a(()=>[d(" 无视警告并继续创建 ")]),_:1}),s(A,{color:"primary",onClick:t[10]||(t[10]=g=>i.handleOneBotEmptyTokenWarningDismiss(!1))},{default:a(()=>[d(" 重新修改 ")]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),s(le,{modelValue:o.showConfigDrawer,"onUpdate:modelValue":t[12]||(t[12]=g=>o.showConfigDrawer=g),class:"config-drawer-overlay",location:"right",transition:"slide-x-reverse-transition",scrim:!0,"onClick:outside":i.closeConfigDrawer},{default:a(()=>[s(D,{class:"config-drawer-card",elevation:"12"},{default:a(()=>[r("div",ft,[r("div",null,[ct,o.configDrawerTargetId?(m(),u("div",mt," ID: "+f(o.configDrawerTargetId),1)):w("",!0)]),s(A,{icon:"",variant:"text",onClick:i.closeConfigDrawer},{default:a(()=>[s(h,null,{default:a(()=>[d("mdi-close")]),_:1})]),_:1},8,["onClick"])]),s(ae),r("div",gt,[o.showConfigDrawer?(m(),C(b,{key:0,"initial-config-id":o.configDrawerTargetId},null,8,["initial-config-id"])):w("",!0)])]),_:1})]),_:1},8,["modelValue","onClick:outside"])],64)}const ht=K(be,[["render",ut]]);const pt={name:"PlatformPage",components:{AstrBotConfig:F,WaitingForRestart:ue,ConsoleDisplayer:he,ItemCard:ge,AddNewPlatform:ht},setup(){const{t:e}=ie(),{tm:t}=Q("features/platform");return{t:e,tm:t}},data(){return{config_data:{},fetched:!1,metadata:{},showAddPlatformDialog:!1,updatingPlatformConfig:{},updatingMode:!1,save_message_snack:!1,save_message:"",save_message_success:"success",showConsole:localStorage.getItem("platformPage_showConsole")==="true",showWebhookDialog:!1,currentWebhookUuid:"",platformStats:{},statsRefreshInterval:null,showErrorDialog:!1,currentErrorPlatform:null,store:we()}},watch:{showConsole(e){localStorage.setItem("platformPage_showConsole",e.toString())},showIdConflictDialog(e){!e&&this.idConflictResolve&&(this.idConflictResolve(!1),this.idConflictResolve=null)},showOneBotEmptyTokenWarnDialog(e){!e&&this.oneBotEmptyTokenWarningResolve&&(this.oneBotEmptyTokenWarningResolve(!0),this.oneBotEmptyTokenWarningResolve=null)}},mounted(){this.getConfig(),this.getPlatformStats(),this.statsRefreshInterval=setInterval(()=>{this.getPlatformStats()},1e4)},beforeUnmount(){this.statsRefreshInterval&&clearInterval(this.statsRefreshInterval)},methods:{getPlatformIcon(e){var n,l,o,i;const t=(i=(o=(l=(n=this.metadata.platform_group)==null?void 0:n.metadata)==null?void 0:l.platform)==null?void 0:o.config_template)==null?void 0:i[e];return t&&t.logo_token?`/api/file/${t.logo_token}`:Z(e)},getConfig(){y.get("/api/config/get").then(e=>{this.config_data=e.data.data.config,this.fetched=!0,this.metadata=e.data.data.metadata}).catch(e=>{this.showError(e)})},getPlatformStats(){y.get("/api/platform/stats").then(e=>{if(e.data.status==="ok"){const t={};for(const n of e.data.data.platforms||[])t[n.id]=n;this.platformStats=t}}).catch(e=>{console.warn("获取平台统计信息失败:",e)})},getPlatformStat(e){return this.platformStats[e]||null},getStatusColor(e){switch(e){case"running":return"success";case"error":return"error";case"pending":return"warning";case"stopped":return"grey";default:return"grey"}},getStatusIcon(e){switch(e){case"running":return"mdi-check-circle";case"error":return"mdi-alert-circle";case"pending":return"mdi-clock-outline";case"stopped":return"mdi-stop-circle";default:return"mdi-help-circle"}},showErrorDetails(e){const t=this.getPlatformStat(e.id);t&&t.error_count>0&&(this.currentErrorPlatform=t,this.showErrorDialog=!0)},editPlatform(e){this.updatingPlatformConfig=JSON.parse(JSON.stringify(e)),this.updatingMode=!0,this.showAddPlatformDialog=!0,this.$nextTick(()=>{this.$refs.addPlatformDialog.toggleShowConfigSection()})},deletePlatform(e){confirm(`${this.messages.deleteConfirm} ${e.id}?`)&&y.post("/api/config/platform/delete",{id:e.id}).then(t=>{this.getConfig(),this.showSuccess(t.data.message||this.messages.deleteSuccess)}).catch(t=>{var n,l;this.showError(((l=(n=t.response)==null?void 0:n.data)==null?void 0:l.message)||t.message)})},platformStatusChange(e){e.enable=!e.enable,y.post("/api/config/platform/update",{id:e.id,config:e}).then(t=>{this.getConfig(),this.showSuccess(t.data.message||this.messages.statusUpdateSuccess)}).catch(t=>{var n,l;e.enable=!e.enable,this.showError(((l=(n=t.response)==null?void 0:n.data)==null?void 0:l.message)||t.message)})},showToast({message:e,type:t}){t==="success"?this.showSuccess(e):t==="error"&&this.showError(e)},showSuccess(e){this.save_message=e,this.save_message_success="success",this.save_message_snack=!0},showError(e){this.save_message=e,this.save_message_success="error",this.save_message_snack=!0},getWebhookUrl(e){let t=this.config_data.callback_api_base||"";return t||(t="http(s)://<your-domain-or-ip>"),t?`${t.replace(/\/$/,"")}/api/platform/webhook/${e}`:`/api/platform/webhook/${e}`},openWebhookDialog(e){this.currentWebhookUuid=e,this.showWebhookDialog=!0},async copyWebhookUrl(e){const t=this.getWebhookUrl(e);try{await navigator.clipboard.writeText(t),this.showSuccess(this.tm("webhookCopied"))}catch{this.showError(this.tm("webhookCopyFailed"))}}},computed:{messages(){return{updateSuccess:this.tm("messages.updateSuccess"),addSuccess:this.tm("messages.addSuccess"),deleteSuccess:this.tm("messages.deleteSuccess"),statusUpdateSuccess:this.tm("messages.statusUpdateSuccess"),deleteConfirm:this.tm("messages.deleteConfirm")}},currentWebhookUrl(){return this.getWebhookUrl(this.currentWebhookUuid)}}},At={class:"platform-page"},wt={class:"text-h1 font-weight-bold mb-2 d-flex align-center"},vt={class:"text-subtitle-1 text-medium-emphasis mb-4"},Ct={class:"text-grey mt-4"},bt={key:0,class:"platform-status-row mb-2"},yt={key:1,class:"webhook-info"},_t={class:"text-h4"},kt={class:"text-body-2 text-medium-emphasis mb-3"},Dt={class:"mb-3"},Pt={class:"mb-3"},It={key:0,class:"error-details"},Rt={class:"mb-2"},xt={class:"error-message"},Vt={class:"error-time text-caption text-medium-emphasis mt-1"},Et={key:0},Bt={class:"mb-2"},Tt={class:"traceback-box"};function St(e,t,n,l,o,i){const v=I("item-card"),_=I("ConsoleDisplayer"),b=I("AddNewPlatform");return m(),u("div",At,[s(ne,{fluid:"",class:"pa-0"},{default:a(()=>[s(U,{class:"d-flex justify-space-between align-center px-4 py-3 pb-8"},{default:a(()=>[r("div",null,[r("h1",wt,[s(h,{color:"black",class:"me-2"},{default:a(()=>[d("mdi-robot")]),_:1}),d(f(l.tm("title")),1)]),r("p",vt,f(l.tm("subtitle")),1)]),s(A,{color:"primary","prepend-icon":"mdi-plus",variant:"tonal",onClick:t[0]||(t[0]=g=>{o.updatingMode=!1,o.showAddPlatformDialog=!0}),rounded:"xl",size:"x-large"},{default:a(()=>[d(f(l.tm("addAdapter")),1)]),_:1})]),_:1}),r("div",null,[(o.config_data.platform||[]).length===0?(m(),C(U,{key:0},{default:a(()=>[s(X,{cols:"12",class:"text-center pa-8"},{default:a(()=>[s(h,{size:"64",color:"grey-lighten-1"},{default:a(()=>[d("mdi-connection")]),_:1}),r("p",Ct,f(l.tm("emptyText")),1)]),_:1})]),_:1})):(m(),C(U,{key:1},{default:a(()=>[(m(!0),u(Y,null,de(o.config_data.platform||[],(g,P)=>(m(),C(X,{key:P,cols:"12",md:"6",lg:"4",xl:"3"},{default:a(()=>[s(v,{item:g,"title-field":"id","enabled-field":"enable",bglogo:i.getPlatformIcon(g.type||g.id),onToggleEnabled:i.platformStatusChange,onDelete:i.deletePlatform,onEdit:i.editPlatform},{"item-details":a(({item:c})=>{var p,V,O,L,N,G,H;return[i.getPlatformStat(c.id)&&(((p=i.getPlatformStat(c.id))==null?void 0:p.status)!=="running"||((V=i.getPlatformStat(c.id))==null?void 0:V.error_count)>0)?(m(),u("div",bt,[((O=i.getPlatformStat(c.id))==null?void 0:O.status)!=="running"?(m(),C(W,{key:0,size:"small",color:i.getStatusColor((L=i.getPlatformStat(c.id))==null?void 0:L.status),variant:"tonal",class:"status-chip"},{default:a(()=>{var k;return[s(h,{size:"small",start:""},{default:a(()=>{var z;return[d(f(i.getStatusIcon((z=i.getPlatformStat(c.id))==null?void 0:z.status)),1)]}),_:2},1024),d(" "+f(l.tm("runtimeStatus."+(((k=i.getPlatformStat(c.id))==null?void 0:k.status)||"unknown"))),1)]}),_:2},1032,["color"])):w("",!0),((N=i.getPlatformStat(c.id))==null?void 0:N.error_count)>0?(m(),C(W,{key:1,size:"small",color:"error",variant:"tonal",class:fe(["error-chip",{"ms-2":((G=i.getPlatformStat(c.id))==null?void 0:G.status)!=="running"}]),onClick:j(k=>i.showErrorDetails(c),["stop"])},{default:a(()=>{var k;return[s(h,{size:"small",start:""},{default:a(()=>[d("mdi-bug")]),_:1}),d(" "+f((k=i.getPlatformStat(c.id))==null?void 0:k.error_count)+" "+f(l.tm("runtimeStatus.errors")),1)]}),_:2},1032,["class","onClick"])):w("",!0)])):w("",!0),(H=i.getPlatformStat(c.id))!=null&&H.unified_webhook&&c.webhook_uuid?(m(),u("div",yt,[s(W,{size:"small",color:"primary",variant:"tonal",class:"webhook-chip",onClick:j(k=>i.openWebhookDialog(c.webhook_uuid),["stop"])},{default:a(()=>[s(h,{size:"small",start:""},{default:a(()=>[d("mdi-webhook")]),_:1}),d(" "+f(l.tm("viewWebhook")),1)]),_:2},1032,["onClick"])])):w("",!0)]}),_:2},1032,["item","bglogo","onToggleEnabled","onDelete","onEdit"])]),_:2},1024))),128))]),_:1}))]),s(D,{elevation:"0",class:"mt-4 mb-10"},{default:a(()=>[s(T,{class:"d-flex align-center py-3 px-4"},{default:a(()=>[s(h,{class:"me-2"},{default:a(()=>[d("mdi-console-line")]),_:1}),r("span",_t,f(l.tm("logs.title")),1),s(x),s(A,{variant:"text",color:"primary",onClick:t[1]||(t[1]=g=>o.showConsole=!o.showConsole)},{default:a(()=>[d(f(o.showConsole?l.tm("logs.collapse"):l.tm("logs.expand"))+" ",1),s(h,null,{default:a(()=>[d(f(o.showConsole?"mdi-chevron-up":"mdi-chevron-down"),1)]),_:1})]),_:1})]),_:1}),s(ce,null,{default:a(()=>[o.showConsole?(m(),C(R,{key:0,class:"pa-0"},{default:a(()=>[s(_,{style:{"background-color":"#1e1e1e",height:"300px","border-radius":"0"}})]),_:1})):w("",!0)]),_:1})]),_:1})]),_:1}),s(b,{show:o.showAddPlatformDialog,"onUpdate:show":t[2]||(t[2]=g=>o.showAddPlatformDialog=g),metadata:o.metadata,config_data:o.config_data,ref:"addPlatformDialog","updating-mode":o.updatingMode,"updating-platform-config":o.updatingPlatformConfig,onUpdate:i.getConfig,onShowToast:i.showToast,onRefreshConfig:i.getConfig},null,8,["show","metadata","config_data","updating-mode","updating-platform-config","onUpdate","onShowToast","onRefreshConfig"]),s(B,{modelValue:o.showWebhookDialog,"onUpdate:modelValue":t[5]||(t[5]=g=>o.showWebhookDialog=g),"max-width":"600"},{default:a(()=>[s(D,null,{default:a(()=>[s(T,{class:"d-flex align-center pa-4"},{default:a(()=>[s(h,{class:"me-2",color:"primary"},{default:a(()=>[d("mdi-webhook")]),_:1}),d(" "+f(l.tm("webhookDialog.title")),1)]),_:1}),s(R,{class:"px-4 pb-2"},{default:a(()=>[r("p",kt,f(l.tm("webhookDialog.description")),1),s(M,{"model-value":i.currentWebhookUrl,readonly:"",variant:"outlined","hide-details":"",class:"webhook-url-field"},{"append-inner":a(()=>[s(A,{icon:"",size:"small",variant:"text",onClick:t[3]||(t[3]=g=>i.copyWebhookUrl(o.currentWebhookUuid))},{default:a(()=>[s(h,null,{default:a(()=>[d("mdi-content-copy")]),_:1})]),_:1})]),_:1},8,["model-value"])]),_:1}),s(E,{class:"pa-4 pt-2"},{default:a(()=>[s(x),s(A,{variant:"tonal",color:"primary",onClick:t[4]||(t[4]=g=>o.showWebhookDialog=!1)},{default:a(()=>[d(f(l.tm("webhookDialog.close")),1)]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),s(B,{modelValue:o.showErrorDialog,"onUpdate:modelValue":t[7]||(t[7]=g=>o.showErrorDialog=g),"max-width":"700"},{default:a(()=>[s(D,null,{default:a(()=>[s(T,{class:"d-flex align-center pa-4"},{default:a(()=>[s(h,{class:"me-2",color:"error"},{default:a(()=>[d("mdi-alert-circle")]),_:1}),d(" "+f(l.tm("errorDialog.title")),1)]),_:1}),o.currentErrorPlatform?(m(),C(R,{key:0,class:"px-4 pb-4"},{default:a(()=>[r("div",Dt,[r("strong",null,f(l.tm("errorDialog.platformId"))+":",1),d(" "+f(o.currentErrorPlatform.id),1)]),r("div",Pt,[r("strong",null,f(l.tm("errorDialog.errorCount"))+":",1),d(" "+f(o.currentErrorPlatform.error_count),1)]),o.currentErrorPlatform.last_error?(m(),u("div",It,[r("div",Rt,[r("strong",null,f(l.tm("errorDialog.lastError"))+":",1)]),s(me,{type:"error",variant:"tonal",class:"mb-3"},{default:a(()=>[r("div",xt,f(o.currentErrorPlatform.last_error.message),1),r("div",Vt,f(l.tm("errorDialog.occurredAt"))+": "+f(new Date(o.currentErrorPlatform.last_error.timestamp).toLocaleString()),1)]),_:1}),o.currentErrorPlatform.last_error.traceback?(m(),u("div",Et,[r("div",Bt,[r("strong",null,f(l.tm("errorDialog.traceback"))+":",1)]),r("pre",Tt,f(o.currentErrorPlatform.last_error.traceback),1)])):w("",!0)])):w("",!0)]),_:1})):w("",!0),s(E,{class:"pa-4 pt-0"},{default:a(()=>[s(x),s(A,{variant:"tonal",color:"primary",onClick:t[6]||(t[6]=g=>o.showErrorDialog=!1)},{default:a(()=>[d(f(l.tm("errorDialog.close")),1)]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),s(re,{timeout:3e3,elevation:"24",color:o.save_message_success,modelValue:o.save_message_snack,"onUpdate:modelValue":t[8]||(t[8]=g=>o.save_message_snack=g),location:"top"},{default:a(()=>[d(f(o.save_message),1)]),_:1},8,["color","modelValue"])])}const Yt=K(pt,[["render",St],["__scopeId","data-v-80129425"]]);export{Yt as default};
