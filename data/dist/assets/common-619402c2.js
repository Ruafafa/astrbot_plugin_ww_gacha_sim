import{b3 as v,K as m}from"./index-61371d60.js";const E=v({id:"common",state:()=>({eventSource:null,log_cache:[],sse_connected:!1,log_cache_max_len:1e3,startTime:-1,pluginMarketData:[]}),actions:{async createEventSource(){if(this.eventSource)return;const o=new AbortController,{signal:a}=o,s={"Content-Type":"multipart/form-data",Authorization:"Bearer "+localStorage.getItem("token")};fetch("/api/live-log",{method:"GET",headers:s,signal:a,cache:"no-cache"}).then(t=>{if(!t.ok)throw new Error(`SSE connection failed: ${t.status}`);console.log("SSE stream opened"),this.sse_connected=!0;const r=t.body.getReader(),c=new TextDecoder;let e="";const l=({done:x,value:f})=>{if(x){console.log("SSE stream closed"),setTimeout(()=>{this.eventSource=null,this.createEventSource()},2e3);return}const g=c.decode(f,{stream:!0});e+=g;const d=e.split(`

`);return e=d.pop()||"",d.forEach(p=>{const h=p.trim();if(!h.startsWith("data: "))return;const i=h.replace("data: ","").trim();if(i)try{const n=JSON.parse(i);n.uuid||(typeof crypto<"u"&&typeof crypto.randomUUID=="function"?n.uuid=crypto.randomUUID():n.uuid="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(_){var u=Math.random()*16|0,S=_=="x"?u:u&3|8;return S.toString(16)})),this.log_cache.push(n),this.log_cache.length>this.log_cache_max_len&&this.log_cache.splice(0,this.log_cache.length-this.log_cache_max_len)}catch(n){console.warn("Failed to parse SSE log line, skipping:",n,i)}}),r.read().then(l)};r.read().then(l)}).catch(t=>{console.error("SSE error:",t),this.log_cache.push({type:"log",level:"ERROR",time:Date.now()/1e3,data:"SSE Connection failed, retrying in 5 seconds...",uuid:"error-"+Date.now()}),setTimeout(()=>{this.eventSource=null,this.createEventSource()},1e3)}),this.eventSource=o},closeEventSourcet(){this.eventSource&&(this.eventSource.abort(),this.eventSource=null)},getLogCache(){return this.log_cache},getStartTime(){if(this.startTime!==-1)return this.startTime;m.get("/api/stat/start-time").then(o=>{this.startTime=o.data.data.start_time})},async getPluginCollections(o=!1,a=null){if(!o&&this.pluginMarketData.length>0&&!a)return Promise.resolve(this.pluginMarketData);let s=o?"/api/plugin/market_list?force_refresh=true":"/api/plugin/market_list";return a&&(s+=(s.includes("?")?"&":"?")+`custom_registry=${encodeURIComponent(a)}`),m.get(s).then(t=>{let r=[];if(t.data.data&&typeof t.data.data=="object")for(let c in t.data.data){const e=t.data.data[c];r.push({name:e.name||c,desc:e.desc,author:e.author,repo:e.repo,installed:!1,version:e!=null&&e.version?e.version:"未知",social_link:e==null?void 0:e.social_link,tags:e!=null&&e.tags?e.tags:[],logo:e!=null&&e.logo?e.logo:"",pinned:e!=null&&e.pinned?e.pinned:!1,stars:e!=null&&e.stars?e.stars:0,updated_at:e!=null&&e.updated_at?e.updated_at:"",display_name:e!=null&&e.display_name?e.display_name:""})}return this.pluginMarketData=r,r}).catch(t=>Promise.reject(t))}}});export{E as u};
